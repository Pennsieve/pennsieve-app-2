<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../shared/bf-ajax-behavior.html">
<link rel="import" href="../../state/bf-state-aware-behavior.html">
<link rel="import" href="../../data/bf-viewer/bf-viewer-side-panel-empty-state.html">
<link rel="import" href="bf-discussion-add-comment.html">
<link rel="import" href="bf-discussion.html">
<link rel="import" href="../../shared/bf-mentions/bf-mention-tag-behavior.html">
<link rel="import" href="../../shared/vuex-behavior/vuex-behavior.html">

<link rel="import" href="../../../../styles/blackfynn/main.html">

<dom-module id="bf-palette-discussion">

  <template>
    <style include="blackfynn-main-styles"></style>
    <style type="text/css">
      :host {
        position: relative;
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }
      :host([hidden]) {
        display: none;
      }
      #discussionsWrap {
        overflow: scroll;
        @apply(--layout-flex);
      }
      .mentions-overlay {
        background-color: #4A4A4A;
        display: block;
        height: 100%;
        left: 0;
        opacity: .51;
        overflow: hidden;
        position: absolute;
        top: 0;
        width: 100%;
        z-index: 99;
      }
    </style>

    <bf-discussion-add-comment id="addComment" start-discussion></bf-discussion-add-comment>

    <div id="discussionsWrap">
      <template id="discussionRepeater" is="dom-repeat" items="[[vuex.viewer.viewerDiscussions.discussions]]" sort="_sortByTime">
        <bf-discussion
          id="[[item.id]]"
          discussion="[[item]]"
          comments="[[_getComments(item.id, comments.*)]]"
          user-map="[[userMap]]"></bf-discussion>
      </template>
    </div>

    <bf-viewer-side-panel-empty-state hidden$="[[_hasDiscussions]]">
      <img id="illustration" src="/static/images/illustrations/illo-sharing.svg" alt="illustration of two people interacting">
      <p>Add a comment to start a discussion. @mention a team member to send an them an invitation to comment.</p>
    </bf-viewer-side-panel-empty-state>

    <div class="mentions-overlay" hidden="[[overlayHidden]]" on-tap="_tapOverlay"></div>

    <iron-ajax
      auto$="[[isAuto]]"
      id="getDiscussions"
      method="GET"
      content-type="application/json"
      handle-as="json"
      params="[[getDiscussionsParams]]"
      loading="{{loadingDiscussions}}"
      url="[[getDiscussionsUrl]]"
      on-response="_handleGetDiscussions"
      on-error="ajaxError"
      on-iron-ajax-presend="_onGetDiscussionsPresend"></iron-ajax>

    <iron-ajax
      id="createDiscussionAjax"
      method="POST"
      content-type="application/json"
      handle-as="json"
      params="[[getDiscussionsParams]]"
      loading="{{loadingDiscussions}}"
      url="[[createDiscussionsUrl]]"
      on-error="ajaxError"></iron-ajax>

  </template>

  <script>

    Polymer({

      is: 'bf-palette-discussion',

      behaviors: [
        Blackfynn.AjaxBehavior,
        Blackfynn.VuexBehavior,
        Blackfynn.MentionTagBehavior
      ],

      properties: {
        /**
         * User Map
         */
         userMap: {
          type: Object,
          value: function() {
            return {};
          }
        },
        /**
         * Comments
         */
         comments: {
          type: Array,
          value: function() {
            return [];
          }
        },
        /**
         * Determines whether or not overlay is hidden
         */
        overlayHidden: {
          type: Boolean,
          value: true
        },
        /**
         * Discussions for the active viewer's package
         */
        discussions: {
          type: Array,
          value: function() {
            return []
          }
        },
        /**
         * Computed property that returns create discussions api url
         */
         createDiscussionsUrl: {
          type: String,
          computed: '_computeCreateDiscussionsUrl(vuex.config.apiUrl)'
        },
        /**
         * Computed property that returns get discussions api url
         */
        getDiscussionsUrl: {
          type: String,
          computed: '_computeGetDiscussionsUrl(vuex.config.apiUrl, vuex.viewer.content.id, isLoading)'
        },
        /**
         * Computed property that returns get discussions parameters
         */
        getDiscussionsParams: {
          type: Object,
          computed: '_computeGetDiscussionsParams(vuex.userToken)'
        },
        /**
         * Request for loading discussions is processing
         */
        loadingDiscussions: {
          type: Boolean,
          value: false
        },
        /**
         * Computed property if there are any discussions for the package
         */
        _hasDiscussions: {
          type: Boolean,
          computed: '_computeHasDiscussions(vuex.viewer.viewerDiscussions.discussions.length)'
        },
         /**
         * determines whether or not to make api calls
         */
        isAuto: {
          type: Boolean,
          computed: '_computeIsAuto(vuex.viewer.viewerSidePanelView, requestedDiscussions)'
        },
        /**
         * Are discussions loading from API
        */
        isLoading: {
          type: Boolean,
          value: false
        },
        /**
         * Has sent request for discussions
        */
        requestedDiscussions: {
          type: Boolean,
          value: false
        }
      },

      observers: [
        '_watchViewer(vuex.viewer.content.id)'
      ],

      listeners: {
        'create-discussion': 'createDiscussion',
        'delete-discussion': 'deleteDiscussion',
        'hide-overlay': 'hideOverlay'
      },

      _watchViewer: function(id) {
        console.log(id)
      },

      /**
       * Get the list of comments per discussion
       * @param {String} itemId
       * @param {Object} comments
       */
      _getComments: function(itemId, comments) {
        const base = R.prop('base', comments);
        const _comments = R.prop(itemId, base);

        return _comments;
      },

      /**
       * Handles GET discussions response
       * @param {Object} detail
       */
      _handleGetDiscussions: function(e, detail) {
        this.set('isLoading', false)
        const response = R.propOr({}, 'response', detail);
        this.$store.dispatch('viewer/setDiscussions', response)
      },

      /**
       * Computes when to make API call for package list
       * @param {String} sidePanelView
       * @param {Boolean} requestedDiscussions
       * @returns {Boolean}
       */
      _computeIsAuto(sidePanelView, requestedDiscussions) {
        return sidePanelView === 'discussion' && requestedDiscussions === false;
      },

      /**
       * tap event to close overlay
       */
      _tapOverlay: function() {
        this.hideOverlay({detail: true});

        const newComment = this.$.addComment;
        newComment.$.mentions.set('hideMentions', true);
        newComment.removeAttribute('mentions-active');

        const discussions = Polymer.dom(this.root).querySelectorAll('bf-discussion');
        discussions.forEach(discussion => {
          const comment = discussion.$.addcomment;
          comment.removeAttribute('mentions-active');
          comment.$.mentions.set('hideMentions', true);
        });
      },

      /**
       * toggles overlay visibility
       */
      hideOverlay: function(e) {
        if (typeof e.detail === 'boolean') {
          this.set('overlayHidden', e.detail);
        }
      },

      /**
       * Returns get discussions api endpoint
       * @param {Number} discussionsLength
       * @return {Boolean}
       */
      _computeHasDiscussions: function(discussionsLength) {
        return discussionsLength > 0;
      },

      /**
       * Returns get discussions api endpoint
       * @param {String} apiUrl
       * @param {String} id
       * @param {Boolean} isLoading
       * @return {String} discussions endpoint
       */
      _computeGetDiscussionsUrl: function(apiUrl, id, isLoading) {
        if (id && !isLoading) {
          return `${apiUrl}/discussions/package/${id}`;
        }
      },

      /**
       * Returns create discussions api endpoint
       * @param {String} apiUrl
       * @return {String} discussions endpoint
       */
       _computeCreateDiscussionsUrl: function(apiUrl) {
        return `${apiUrl}/discussions`;
      },

      /**
       * Returns parameters for get discussions
       * @param {String} userToken
       * @return {Object} ajax parameters
       */
      _computeGetDiscussionsParams: function(userToken) {
        return {
          api_key: userToken
        }
      },

      /**
       * Callback before the XHR request gets sent for getting discussions
       * @param {Object} Event object
       */
      _onGetDiscussionsPresend: function(e) {
        this.isLoading = true
        this.set('requestedDiscussions', true)
        if (!this.getDiscussionsParams.api_key) {
          e.preventDefault();
        }
      },

      /**
       * Callback of XHR request to create discussion
       * @param {Object} Event object
       * @param {Object} detail
       */
      createDiscussion: function(e, detail) {
        const xhr = this.$.createDiscussionAjax;
        const message = R.prop('message', detail);
        const mentions = R.prop('mentions', detail);
        const packageId = R.path(['content', 'id'])(this.vuex.viewer.activeViewer);
        const viewer = this.$store.getters.getViewer
        const packageType = R.path(['content', 'packageType'], viewer);

        const transformedMessage = message.replace(/\<span(.*?)\<\/span>/g, this.createMentionTag);

        xhr.body = {
          message: transformedMessage,
          packageId,
          mentions
        };
        const annotationId = R.propOr(0, ['annotationId'], detail);
        if (annotationId > 0) {
          const annotationKey = packageType === 'TimeSeries' ?
            'timeSeriesAnnotationId' :
            'annotationId'
          xhr.body[annotationKey] = annotationId
        }
        xhr
          .generateRequest()
          .completes
          .then((payload) => {
            this.$store.dispatch('viewer/createDiscussion', payload)
          });
      },

      /**
       * Delete discussion
       * @param {Object} e
       * @param {Object} detail
       */
      deleteDiscussion: function(e, detail) {
        const discussionId = R.propOr(0, 'discussionId', detail);
        const comments = R.propOr([{}], 'comments', detail);
        if (discussionId === 0 || comments.length > 0) {
          return;
        }
        const discussionIndex = this.getById(discussionId, this.discussions);
        this.splice('discussions', discussionIndex, 1);
      },

      /**
       * Get discussion by ID
       * @param {String}
       * @param {Array}
       * @return {Number}
       */
      getById: R.useWith(R.findIndex, [R.propEq('id')]),

      /**
       * sort function by time
       * @param {String}
       * @param {String}
       */
      _sortByTime: function(a, b) {
        return a < b ? -1 : 1;
      },

      /**
       * Go to a specific discussion
       * @param {string} id
       */
      viewDiscussion: function(id) {
        // Scroll to discussion
        const discussion = Polymer.dom(this.root).querySelector(`#${id}`);
        if(discussion) {
          discussion.scrollIntoView();
        }
      },

      /**
       * Start a discussion
       * @param {string} annotationId
       */
      startDiscussion: function(annotationId) {
        // Set props of the add comment component
        const addComment = this.$.addComment;
        addComment.set('annotationId', annotationId);

        // Focus and select textarea
        const textarea = addComment.$.commentTextarea;
        textarea.focus();
      }

    });

  </script>

</dom-module>
