<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../../bower_components/iron-a11y-keys/iron-a11y-keys.html">

<link rel="import" href="../autosize-input-import.html">

<link rel="import" href="../../../../styles/blackfynn/main.html">
<link rel="import" href="../../../../styles/blackfynn/icons.html">

<!--
`<bf-select-input>` is component to select the playback speed of a timeseries.

    <bf-select-input></bf-select-input>

## Model for dropdown items
Items should be an `Array` of `Objects` containing a `label` and `value` property.
```
[
  {
    label: '50%',
    value: 50
  },
  {
    label: '75%',
    value: 75
  },
  ...
]
```
In a case where a special character is needed in the label, use the `dropdownUnit` property to automatically append the unit.

@element bf-select-input
@demo demo/index.html
-->

<dom-module id="bf-select-input">
  <template>
    <style include="blackfynn-main-styles"></style>
    <style>
      :host {
        display: block;
        font-size: 12px;
        line-height: 1;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        --paper-menu-button: {
          padding: 0;
        }
        --paper-menu-button-content: {
          border-radius: 3px;
          box-shadow: none;
        }
      }
      :host(:hover){
        cursor: pointer;
      }
      #input {
        background: none;
        border: none;
        font: inherit;
        padding: 0;
      }
      #icon {
        color: #000;
        height: 24px;
        margin-right: 5px;
        padding: 0;
        width: 24px;
        --paper-icon-button-ink-color: transparent;
      }
      #icon:focus, #icon:hover {
        color: var(--glial);
      }
      #menu {
        position: absolute;
        right: 5px;
      }
      .dropdown-content {
        padding: 0;
        width: 60px;
      }
      .dropdown-item {
        border-right: 1px solid #BDBDBD;
        border-left: 1px solid #BDBDBD;
        cursor: pointer;
        font-size: 12px;
        line-height: 12px;
        min-height: 0;
        padding: 5px;
      }
      .dropdown-item:first-of-type {
        border-top: 1px solid #BDBDBD;
        border-radius: 3px 3px 0 0;
      }
      .dropdown-item:last-of-type {
        border-bottom: 1px solid #BDBDBD;
        border-radius: 0 0 3px 3px;
      }
      .dropdown-item:hover, .dropdown-item:focus, .dropdown-item.iron-selected {
        background: var(--dopamine);
        border-color: var(--dopamine);
        color: var(--white-matter);
        outline: none;
      }
      #inputWrap {
        background: var(--white-matter);
        border: 1px solid #BDBDBD;
        border-radius: 3px;
        box-sizing: border-box;
        cursor: default;
        min-width: 65px;
        padding: 5px 27px 5px 5px;
        position: relative;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .caret {
        height: 5px;
        width: 9px;
      }
      .value {
        color: #000;
        font-size: 12px;
        @apply(--layout-flex-auto);
      }
    </style>

    <paper-icon-button
      alt="[[label]]"
      id="icon"
      icon="[[labelIcon]]"
      noink
      on-tap="focusInput"></paper-icon-button>

    <div id="inputWrap" on-tap="_onInputWrapTap">

      <input
        id="input"
        is="iron-input"
        bind-value="{{_value}}"
        allowed-pattern="[[allowedPattern]]"
        on-blur="setValue">

      <span hidden$="[[!unit]]">[[unit]]</span>

      <paper-menu-button
        id="menu"
        vertical-align="top"
        vertical-offset="-7"
        horizontal-align="right"
        horizontal-offset="-6"
        opened="{{isOpen}}">

        <iron-icon
          class="caret dropdown-trigger"
          icon="[[dropdownIcon]]"
          noink></iron-icon>

        <paper-listbox id="dropdown" class="dropdown-content" selected="{{value}}" attr-for-selected="value">
          <template is="dom-repeat" items="[[items]]">
            <paper-item class="dropdown-item" value="[[item.value]]">[[item.label]]<span hidden$="[[!dropdownUnit]]">[[unit]]</span></paper-item>
          </template>
        </paper-listbox>

      </paper-menu-button>

    </div>

    <iron-a11y-keys
      target="[[inputField]]"
      keys="enter"
      on-keys-pressed="setValue"></iron-a11y-keys>
  </template>

  <script>
    Polymer({
      is: 'bf-select-input',

      properties: {
        /**
         * Selected value
         */
        value: {
          type: String,
          notify: true,
          observer: 'watchValue'
        },
        /**
         * User entered value
         */
        _value: {
          type: String
        },
        /**
         * Items to be displayed in dropdown
         */
        items: {
          type: Array,
          value: function() {
            return [];
          }
        },
        /**
         * Whether the dropdown is open or not
         */
        isOpen: {
          type: Boolean,
          value: false
        },
        /**
         * Icon for the dropdown menu
         */
        dropdownIcon: {
          type: String,
          computed: '_computeIcon(isOpen)'
        },
        /**
         * Input field
         * @type {?Node}
         */
        inputField: {
          type: Object,
          value: function() {
            return this.$.input;
          }
        },
        /**
         * Unit for the value
         */
        unit: {
          type: String
        },
        /**
         * Regular expression that list the characters allowed as input.
         * This pattern represents the allowed characters for the field; as the user inputs text,
         * each individual character will be checked against the pattern (rather than checking
         * the entire value as a whole). The recommended format should be a list of allowed characters;
         * for example, `[a-zA-Z0-9.+-!;:]`
         */
        allowedPattern: {
          type: String
        },
        /**
         * Label for field, used for accessibility
         */
        label: {
          type: String,
          value: 'Input field'
        },
        /**
         * Icon for label
         */
        labelIcon: {
          type: String
        },
        /**
         * Display unit in dropdown item label
         */
        dropdownUnit: {
          type: Boolean,
          value: false
        }
      },

      listeners: {
        'menu.paper-dropdown-open': '_onMenuOpen',
        'menu.iron-select': '_onSelect'
      },

      attached: function() {
        // Initialize autosize input field
        autosizeInput(this.$.input);
      },

      /**
       * Observe the value
       * @param {String} value
       */
      watchValue: function(value) {
        this.set('_value', value);

        // Notify element of change to resize
        this.fire('input', null, { bubbles: false, node: this.$.input});
      },

      /**
       * Callback when menu opens
       */
      _onMenuOpen: function() {
        // Set dropdown width to be the same width
        this.$.dropdown.style.width = `${this.$.inputWrap.offsetWidth}px`;
      },

      /**
       * Computes if the icon should be up or down based on if the dropdown is open
       * @param {Boolean} isOpen
       * @return {String}
       */
      _computeIcon: function(isOpen) {
        return isOpen ? 'blackfynn:chevron-up-small' : 'blackfynn:chevron-down-small';
      },

      /**
       * Set the value
       */
      setValue: function() {
        this.set('value', this._value);
      },

      /**
       * Ensure that the menu is closed when the user selects an item
       */
      _onSelect: function() {
        this.$.menu.close();
      },

      /**
       * Input wrap tap callback
       * Only focus input if the user is not tapping on menu or menu icon
       * @param {Event} e
       */
      _onInputWrapTap: function(e) {
        const inputWrap = this.$.inputWrap;
        if(e.target === inputWrap || e.target.parentElement === inputWrap) {
          this.focusInput();
        }
      },

      /**
       * Focus on input
       */
      focusInput: function() {
        this.$.input.focus();
      }
    });
  </script>
</dom-module>
