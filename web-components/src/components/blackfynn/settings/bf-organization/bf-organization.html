<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../../../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../shared/bf-package-sort-behavior.html">
<link rel="import" href="../../data/bf-data-size-formatting-behavior.html">
<link rel="import" href="../../shared/bf-input/bf-input.html">
<link rel="import" href="../../state/bf-state-aware-behavior.html">
<link rel="import" href="../../shared/bf-ajax-behavior.html">
<link rel="import" href="../../../../vendor-scripts.html">

<link rel="import" href="../../../../styles/blackfynn/main.html">
<link rel="import" href="../../../../styles/blackfynn/data-item.html">
<link rel="import" href="../../../../styles/blackfynn/settings.html">

<dom-module id="bf-organization">

  <template>

    <style include="blackfynn-main-styles"></style>
    <style include="bf-data-item-styles"></style>
    <style include="blackfynn-settings-styles"></style>
    <style>
      :host {
        display: block;
      }
      h2 {
        margin-bottom: 30px;
      }
      bf-input {
        max-width: 330px;
      }
      .dataset-wrap {
        border: solid 1px var(--cortex);
        border-radius: 2px;
        max-width: 725px;
      }
      .wrap {
        margin: 0 30px 30px 30px;
      }
      .divider {
        background: var(--cortex);
        height: 1px;
        margin: 50px 1px 40px 1px;
      }
      .row {
        padding: 18px 20px;
        border-top: solid 1px var(--cortex);
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .row.first {
        border-top: none !important;
      }
      .headers {
        background: var(--dendrite);
        border-bottom: 1px solid  var(--cortex);
        font-size: 12px;
        font-weight: 500;
        line-height: 13px;
        padding: 18px 20px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .col-name, .col-lastName {
        flex: 3;
      }
      #dataSpinner {
        margin: 18px 20px;
      }
      .storage-used {
        color: var(--glial);
        font-size: 12px;
        line-height: 14px;
      }
      .storage-display {
        line-height: 24px;
      }
      .storage-display .number {
        font-size: 28px;
      }
      .storage-display .unit {
        font-size: 12px;
        text-transform: uppercase;
      }
      .storage-display-wrap {
        padding: 16px;
        border: solid 1px var(--cortex);
        border-radius: 5px;
        width: 296px;
        margin-bottom: 50px;
      }
    </style>

    <div class="wrap">
      <h2>Organization Settings</h2>

      <bf-input
        label="Organization Name"
        value="{{state.activeOrganization.organization.name}}"></bf-input>

      <div class="form-button">
        <paper-button
          class="save"
          noink
          on-tap="updateOrganization">Update Organization</paper-button>

        <paper-spinner-lite
          active$="[[_updatingOrganization]]"></paper-spinner-lite>
      </div>
    </div>

    <div class="divider"></div>

    <div class="wrap">
      <h3>Organization Data Usage</h3>
      <div class="storage-display-wrap">
        <div class="storage-display">
          <span class="number">[[storageNumber]]</span>
          <span class="unit">[[storageUnit]]</span>
        </div>
        <div class="storage-used">Storage Used</div>
      </div>
      <h3>Dataset Usage</h3>
      <div class="dataset-wrap">
        <div class="headers">
          <div class="col col-name" on-tap="setSort" sort-method="name" is-sorting$="[[_isSorting(sortBy, 'name')]]">Datasets <iron-icon class="icon-sort" icon="[[sortIcon]]"></iron-icon></div>
          <div class="col col-lastName" on-tap="setSort" sort-method="lastName" is-sorting$="[[_isSorting(sortBy, 'lastName')]]">Owner <iron-icon class="icon-sort" icon="[[sortIcon]]"></iron-icon></div>
          <div class="col col-size" on-tap="setSort" sort-method="size" is-sorting$="[[_isSorting(sortBy, 'size')]]">Size <iron-icon class="icon-sort" icon="[[sortIcon]]"></iron-icon></div>
        </div>
        <template is="dom-repeat" items="[[data]]" sort="[[_sort(sortBy, sortDirection)]]">
          <div class$="[[_createRowClass(index)]]">
            <div class="col col-name">[[item.name]]</div>
            <div class="col col-lastName">[[item.firstName]] [[item.lastName]]</div>
            <div class="col col-size">[[_convertMetric(item.storage)]]</div>
          </div>
        </template>
        <paper-spinner-lite id="dataSpinner" active$="[[isLoading]]" hidden$="[[!isLoading]]"></paper-spinner-lite>
      </div>
    </div>

    <iron-ajax
      id="getDatasets"
      method="GET"
      url="[[_getDatasetsUrl]]"
      content-type="application/json"
      handle-as="json"
      loading="{{isLoadingDatasets}}"
      on-error="ajaxError">
    </iron-ajax>

    <iron-ajax
      id="getPeople"
      method="GET"
      url="[[_getPeopleUrl]]"
      content-type="application/json"
      handle-as="json"
      loading="{{isLoadingPeople}}"
      on-error="ajaxError">
    </iron-ajax>

    <iron-ajax
      id="updateOrganization"
      method="PUT"
      handle-as="json"
      content-type="application/json"
      loading="{{_updatingOrganization}}"
      url="[[_updateOrganizationrUrl]]"
      on-error="ajaxError"
      on-response="_handleUpdateOrganization"
      debounce-duration="300"></iron-ajax>

  </template>

  <script>

    Polymer({
      is: 'bf-organization',

      behaviors: [
        Blackfynn.AjaxBehavior,
        Blackfynn.DataSizeFormattingBehavior,
        StateAwareBehavior,
        Blackfynn.PackageSortBehavior
      ],

      properties: {
        /**
         * Combined data for org members and datasets
         */
        data: {
          type: Array,
          value: function() {
            return [];
          }
        },
        /**
         * List of dataset ids to pass to ledger
         */
        datasetIds: {
          type: Array,
          value: function() {
            return [];
          }
        },
        /**
         * Tracks when org is updating
         */
        _updatingOrganization: {
          type: Boolean,
          value: false
        },
        /**
         * Tracks when org is updating
         */
         calculatingStorage: {
          type: Boolean,
          value: true
        },
        /**
         * Compute update organization URL
         */
        _updateOrganizationrUrl: {
          type: String,
          computed: '_computeUpdateOrganizationUrl(state.apiUrl, state.userToken, state.activeOrganization.organization.id)'
        },
        /**
         * Compute the endpoint URL to get people
         */
         _getPeopleUrl: {
          type: String,
          computed: '_computeGetPeopleUrl(state.apiUrl, state.userToken, state.activeOrganization.organization.id)'
        },
        /**
         * Computed property that returns data set list api url
         */
         _getDatasetsUrl: {
          type: String,
          computed: '_computeDataSetListUrl(state.apiUrl, state.userToken)'
        },
        /**
         * Compute storage metrics
         */
        storage: {
          type: String,
          computed: '_computeStorage(state.activeOrganization.organization.storage)'
        },
        /**
         * storage number
         */
        storageNumber: {
          type: String,
          value: ''
        },
        /**
         * storage number unit
         */
        storageUnit: {
          type: String,
          value: ''
        },
        /**
         * Compute when XHR calls are requesting data
         */
        isLoading: {
          type: Boolean,
          computed: '_computeIsLoading(isLoadingDatasets, isLoadingPeople)'
        }
      },

      listeners: {
        'iron-selected': '_fetchData'
      },

      observers: [
        '_watchDatasetIds(datasetIds.length, datsetIds)'
      ],

      ready: function() {
        this.set('sortBy', 'size');
        this.set('sortDirection', 'DESC');
      },

      _watchDatasetIds: function(datasetIdsLength, datasetIds) {
        if (datasetIdsLength === 0) {
          return;
        }
      },

      _createRowClass(idx) {
        return idx === 0 ? `row first` : `row`;
      },

      /**
       * Computes when the xhr calls are loading
       * @param {Boolean} isLoadingDatasets
       * @param {Boolean} isLoadingPeople
       * @returns {Boolean}
       */
       _computeIsLoading: function(isLoadingDatasets, isLoadingPeople) {
        return isLoadingDatasets || isLoadingPeople;
      },

      /**
       * Returns datasets api endpoint
       * @param {String} api
       * @param {String} userToken
       * @return {String} datasets endpoint
       */
       _computeDataSetListUrl: function(api, userToken) {
        return `${api}/datasets?api_key=${userToken}`;
      },

      /**
       * Compute the endpoint URL to get people
       * @param {String} api
       * @param {String} user
       * @param {String} activeOrganizationId
       * @returns {String}
       */
       _computeGetPeopleUrl: function(api, user, activeOrganizationId) {
        return `${api}/organizations/${activeOrganizationId}/members?api_key=${user}`;
      },

      /**
       * Compute the endpoint URL to get people
       * @param {String} api
       * @param {String} user
       * @param {String} activeOrganizationId
       * @returns {String}
       */
      _computeUpdateOrganizationUrl: function(api, user, activeOrganizationId) {
        return `${api}/organizations/${activeOrganizationId}?api_key=${user}`;
      },

      /**
       * Update the organization's name
       */
      updateOrganization: function() {
        const name = R.path(['state', 'activeOrganization', 'organization', 'name'])(this);

        // Don't send request again if already processing or if name is empty
        if(!name || this._updatingOrganization) {
          return;
        }

        const updateOrganization = this.$.updateOrganization;
        updateOrganization.body = { name };
        updateOrganization.generateRequest();
      },

      /**
       * Handles successful update of organization
       */
      _handleUpdateOrganization: function() {
        this.fire('toast', { type: 'MESSAGE', msg: 'Organization updated' });
      },

      /**
       * Formats storage number and unit
       * @param {String} storage
       * @param {String}
       */
      _computeStorage: function(storage) {
        const formatted = this._convertMetric(storage);
        const arr = formatted.split(' ');
        if (arr.length === 2) {
          this.set('storageNumber', arr[0]);
          this.set('storageUnit', arr[1]);
        }
      },

      /**
       * Returns dataset ID
       * @param {Object}
       * @returns {String}
       */
      _getDatasetId: R.path(['content', 'id']),

      /**
       * Gets dataset and people data
       */
      _fetchData: function() {
        // get members
        const peopleRequest = this.$.getPeople.generateRequest();
        // get datsets
        const datasetsRequest = this.$.getDatasets.generateRequest();

        const _this = this;
        Promise.all([peopleRequest.completes, datasetsRequest.completes])
          .then( ([peopleResponse, datasetsResponse]) => {
              const people = peopleResponse.response;
              const datasets = datasetsResponse.response;
              const data = datasets.map(d => {
                const owner = _this._getOwner(d.owner, people)
                return {
                  name: R.pathOr('', ['content', 'name'], d),
                  firstName: owner.firstName,
                  lastName: owner.lastName,
                  storage: d.storage,
                }
              });
              _this.set('data', data);
          });
      },

      /**
       * Gets dataset and people data
       * @param {String} ownerId
       * @param {Array} people
       */
      _getOwner: function(ownerId, people) {
        return R.find(R.propEq('id', ownerId), people);
      },
    });

  </script>

</dom-module>
