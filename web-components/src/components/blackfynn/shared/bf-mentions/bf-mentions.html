<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="../bf-input-autocomplete/bf-autocomplete-suggestions.html">
<link rel="import" href="../../shared/vuex-behavior/vuex-behavior.html">
<link rel="import" href="../../shared/bf-ajax-behavior.html">
<link rel="import" href="bf-mentions-behavior.html">
<link rel="import" href="bf-mention-item.html">

<link rel="import" href="../../../../styles/blackfynn/main.html">

<dom-module id="bf-mentions">

  <template>
    <style include="blackfynn-main-styles"></style>
    <style type="text/css">
      :host {
        left: 0;
        overflow: hidden;
        position: absolute;
        top: 100%;
        width: 100%;
        z-index: 100;
        @apply(--layout-vertical);
      }
      #suggestions {
        background: var(--white-matter);
        box-shadow: 1px 4px 10px 0 rgba(0,0,0,0.35);
        overflow-x: hidden;
        overflow-y: scroll;
        max-height: 230px;
        text-align: center;
        width: 100%;
        z-index: 3;
      }
      paper-spinner-lite {
        margin: 10px auto;
      }
    </style>

    <div id="suggestions" hidden$="[[hideMentions]]">
      <paper-spinner-lite active="[[isLoading]]" hidden$="[[!isLoading]]"></paper-spinner-lite>
      <bf-autocomplete-suggestions
        id="suggestionsMenu"
        on-selected-item-changed="onSelectedChanged"
        on-items-changed="onItemsChanged">
        <template is="dom-repeat"
          items="{{mentions}}">
          <bf-mention-item
            profile="[[item]]"
            on-tap="selectMention"></bf-mention-item>
        </template>
      </bf-autocomplete-suggestions>
    </div>

  </template>

  <script>

    Polymer({

      is: 'bf-mentions',

      behaviors: [
        Blackfynn.MentionsBehavior,
        Blackfynn.AjaxBehavior,
        Blackfynn.VuexBehavior
      ],

      properties: {
        /**
         * Toggles paper spinner display
         */
        isLoading: {
          type: Boolean,
          value: true
        },
        membersLoaded: {
          type: Boolean,
          value: false
        }
      },

      listeners: {
        'mentions-triggered': 'onMentionsTriggered'
      },

      observers: [
        'watchInput(inputField)'
      ],

      attached: function() {
        this.$store.watch(
          this.$store.getters.getOrgMembers,
          this._watchActiveOrganizationMembers.bind(this),
          { immediate: true }
        )
      },

      watchInput: function(inputField) {
        this.listen(inputField, 'keyup', 'onKeyUp');
        this.listen(inputField, 'keydown', 'onKeyDown');
      },

      /**
        * Computed property that returns get members api url
        * @param {String} api
        * @param {String} organizationId
        * @return {String}
        */
      _computeMembersUrl: function(api, organizationId) {
        return `${api}/organizations/${organizationId}/members`;
      },

      /**
        * Computed property that returns get members parameters
        * @param {String} userToken
        * @return {Object}
        */
      _computeMembersParams: function(userToken) {
        return {
          api_key: userToken
        }
      },

      _watchActiveOrganizationMembers: function(activeOrganizationMembers) {
        if (this.allMentions.length === 0 && Array.isArray(activeOrganizationMembers)) {
          this.set('isLoading', false)
          this.set('allMentions', activeOrganizationMembers)
          this.set('membersLoaded', true)
          this.fire('toggle-overlay')
        }
      },

      /**
       * Listens for mentions triggered by user event
       * @param {Event} e
       */
      onMentionsTriggered: function(e) {
        e.stopPropagation();
      }

    });

  </script>

</dom-module>
