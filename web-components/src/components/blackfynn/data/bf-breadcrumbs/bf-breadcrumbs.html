<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../vendor-scripts.html">
<link rel="import" href="bf-breadcrumbs-overflow-menu.html">

<link rel="import" href="../../../../styles/blackfynn/main.html">
<link rel="import" href="../../../../styles/blackfynn/icons.html">

<!--
## bf-breadcrumbs

`<bf-breadcrumbs>` is the view for a user's catalog.
-->

<dom-module id="bf-breadcrumbs">

  <template>
    <style include="blackfynn-main-styles"></style>
    <style type="text/css">
      :host {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .breadcrumbs, .breadcrumbs-folders {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-flex);
      }
      .breadcrumbs[hidden], .breadcrumb-wrap[hidden] {
        display: none;
      }
      .icon-home {
        margin-right: 5px;
      }
      .breadcrumb {
        font-size: 18px;
        line-height: 22px;
      }
      .breadcrumb-link {
        cursor: pointer;
        color: var(--glial);
      }
      .ellipses {
        margin-right: 8px;
        width: 17px;
      }
      .breadcrumb-caret {
        color: var(--glial);
        margin-bottom: -1px;
        --iron-icon-height: 21px;
        --iron-icon-width: 21px;
      }
      .breadcrumb-caret[hidden] {
        display: none;
      }
      .overflow-menu-wrap {
        position: relative;
      }
      #overflowMenu {
        margin: 7px 0pt 0pt -20px;
        color: var(--cortex);
        position: absolute;
        width: 250px;
      }
      #overflowMenu:after, #overflowMenu:before {
      	bottom: 100%;
      	left: 11%;
      	content: " ";
      	height: 0;
      	width: 0;
      	position: absolute;
      	pointer-events: none;
      }
    </style>

    <div class="overflow-menu-wrap">

      <iron-icon
        class="breadcrumb-link ellipses"
        hidden$="[[_hideOverflow]]"
        icon="blackfynn:ellipsis_menu"
        on-tap="toggleMenu"></iron-icon>

      <bf-breadcrumbs-overflow-menu
        id="overflowMenu"
        breadcrumbs-overflow="[[_breadcrumbsOverflow]]"></bf-breadcrumbs-overflow-menu>

    </div>

    <template id="breadcrumbRepeat" is="dom-repeat" items="[[_breadcrumbsDisplay]]">
      <div class="breadcrumb breadcrumb-link" on-tap="navigate">[[item.content.name]]</div>
      <iron-icon class="breadcrumb-caret" icon="blackfynn:chevron-right"></iron-icon>
    </template>
    <div class="breadcrumb breadcrumb-current">{{currentBreadcrumb}}</div>
  </template>


  <script>
    Polymer({
      is: 'bf-breadcrumbs',
      properties: {
        breadcrumbs: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true
        },
        _breadcrumbsDisplay: {
          type: Array,
          value: function() {
            return [];
          }
        },
        _breadcrumbsOverflow: {
          type: Array,
          value: function() {
            return [];
          }
        },
        currentBreadcrumb: {
          type: Object,
          computed: '_getCurrentBreadcrumb(curPackage, _rootBreadcrumb.content.name)',
          value: 'Data Catalog'
        },
        /**
         * Show or hide the overflow menu button based off total breadcrumbs and maxBreadcrumbs
         */
        _hideOverflow: {
          type: Boolean,
          computed: '_computeHideOverflow(maxBreadcrumbs, breadcrumbs.length)'
        },
        /**
         * Number of breadcrumbs to be displayed before overflow menu appears
         */
        maxBreadcrumbs: {
          type: Number,
          value: 2
        },
        /**
         * Show or hide the overflow menu
         */
        hideMenu: {
          type: Boolean,
          value: true
        },
        /**
         * Default root breadcrumb element for data sets
         */
        _rootBreadcrumb: {
          type: Object,
          value: function() {
            return {
              content: {
                name: 'Data Catalog'
              }
            }
          }
        }
      },

      /**
       * Determines whether or not root breadcrumb exists in the current breadcrumbs array
       */
      _getCurrentBreadcrumb: function(curPackage, defaultValue) {
        const packageValue = R.pathOr(defaultValue, ['content', 'name'], curPackage);
        return packageValue;
      },

      /**
       * Determines whether or not root breadcrumb exists in the current breadcrumbs array
       */
      _hasRootBreadcrumb: function(breadcrumbs) {
        const defaultValue = this._rootBreadcrumb.content.name;
        return Boolean(
          R.find(R.pathEq(['content', 'name'], defaultValue))(breadcrumbs)
        );
      },

      /**
       * Prepends root breadcrumb element to breadcrumbs array
       */
      _prependRootBreadcrumb: function(breadcrumbs) {
        if (this._hasRootBreadcrumb(breadcrumbs) || this.isSearching || breadcrumbs.length >= this.maxBreadcrumbs) {
          return breadcrumbs;
        }
        return [this._rootBreadcrumb].concat(breadcrumbs);
      },

      /**
       * Prepends root breadcrumb element for data sets curPackage node
       */
      _prependForCurPackage: function(curPackage, rootBreadcrumb, breadcrumbs) {
        const crumbs = R.defaultTo([], breadcrumbs);
        const namePath = R.path(['content', 'name']);
        // check if current package is the same as the root breadcrumb
        if (namePath(curPackage) !== namePath(rootBreadcrumb)) {
          return this._prependRootBreadcrumb(crumbs);
        }
        return crumbs;
      },

      listeners: {
        'navigate': 'navigate'
      },

      observers: [
        'watchBreadcrumbs(breadcrumbs)'
      ],

      /**
       * Split the breadcrumbs into display and overflow arrays, if breadcrumbs total is more than maxBreadcrumbs
       */
      watchBreadcrumbs(breadcrumbs) {
        // reset entire breadcrumb if there is no catalog id in the path
        if (breadcrumbs && breadcrumbs.length) {
          const maxBreadcrumbs = this.maxBreadcrumbs;
          const breadcrumbsDisplay = breadcrumbs.slice(breadcrumbs.length - maxBreadcrumbs);
          const breadcrumbsOverflow = breadcrumbs.slice(0, breadcrumbs.length - maxBreadcrumbs);

          // check for root breadcrumb
          const updatedBreadcrumbs = this._prependRootBreadcrumb(breadcrumbsDisplay);
          const updatedOverflowCrumbs = this._prependRootBreadcrumb(breadcrumbsOverflow);

          this.set('_breadcrumbsDisplay', updatedBreadcrumbs);
          this.set('_breadcrumbsOverflow', updatedOverflowCrumbs.reverse());
        } else {
          // check if current package is the same as the root breadcrumb
          const updatedBreadcrumbs = this._prependForCurPackage(this.curPackage, this._rootBreadcrumb, breadcrumbs);

          this.set('_breadcrumbsDisplay', updatedBreadcrumbs);
          this.set('_breadcrumbsOverflow', updatedBreadcrumbs);
        }
      },

      /**
       * Navigate app through breadcrumb links
       */
      navigate: function(e) {
        // Hide the overflow menu
        this.$.overflowMenu.close();
        const data = R.pathOr({}, ['model', 'item', 'content'], e);
        this.fire('breadcrumb-navigate', { data } );
        this.fire('hide-info-panel');
      },

      /**
       * Compute to show or hide the overflow menu
       */
      _computeHideOverflow: function(maxBreadcrumbs, breadcrumbsLength) {
        // Add 1 to breadcrumbsLength to account for open collection
        return (breadcrumbsLength + 1) <= maxBreadcrumbs;
      },

      /**
       * Toggle the breadcrumb menu
       */
      toggleMenu: function() {
        this.$.overflowMenu.toggle();
      }
    });

  </script>

</dom-module>
