<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt

NOTE: bf-data-behavior utilizes bf-data-item-behavior so these tests cover both behaviors
-->
<html>
<head>

  <title>bf-data-behavior + bf-data-item-behavior tests</title>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">

  <script src="../../../../../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../../../../../bower_components/web-component-tester/browser.js"></script>

  <link rel="import" href="./test-component.html">
</head>
<body>

  <test-fixture id="basic">
    <template is="dom-template">
      <test-component id="test" data="[[data]]"></test-component>
    </template>
  </test-fixture>

  <script>
    suite('basic', function() {
      const val = {
        "key": "created",
        "value": "1489004666713",
        "dataType": "date",
        "fixed": true,
        "hidden": false,
        "display": "March 08, 2017"
      };
      const properties = [{
        "category": "Blackfynn",
        "properties": [val]
      }];
      let basic;
      let _selectItemSpy;
      let _setEditingSpy;
      let _renameItemSpy;
      let _setTempUploadDestSpy;
      let _endDragItemSpy;
      let _moveItemSpy;
      let _openMenuSpy;

      setup(function() {
        basic = fixture('basic', {
          data: {
            content: {
              id: 'N:dataset:5a6779a4-e3d8-473f-91d0-0a99f144dc44',
              name: 'Blackfynn',
              packageType: 'DataSet',
              state: 'READY'
            }
          }
        });
        _selectItemSpy = sinon.spy(basic, '_selectItem');
        _setEditingSpy = sinon.spy(basic, '_setEditing');
        _renameItemSpy = sinon.spy(basic, '_renameItem');
        _startDragItemSpy = sinon.spy(basic, '_startDragItem');
        _setTempUploadDestSpy = sinon.spy(basic, '_setTempUploadDest');
        _endDragItemSpy = sinon.spy(basic, '_endDragItem');
        _moveItemSpy = sinon.spy(basic, '_moveItem');
        _openMenuSpy = sinon.spy(basic, '_openMenu');
      });

      teardown(function() {
        _selectItemSpy.restore();
        _setEditingSpy.restore();
        _renameItemSpy.restore();
        _startDragItemSpy.restore();
        _endDragItemSpy.restore();
        _moveItemSpy.restore();
        _openMenuSpy.restore();
      });

      test('Can determine if package is a dataset', function() {
        const isDataset = basic._computeIsDataSet('DataSet');
        expect(isDataset).to.be.true;

        const isNotDataset = basic._computeIsDataSet('Collection');
        expect(isNotDataset).to.be.false;
      });

      test('Can determine if package is a collection', function() {
        const nodeTypes = ['collection', 'dataset'];

        const isCollection = basic._computeIsCollection('Collection', nodeTypes);
        expect(isCollection).to.be.true;

        const isNotCollection = basic._computeIsCollection('Blah', nodeTypes);
        expect(isNotCollection).to.be.false;

        const badInputs = basic._computeIsDataSet(null, []);
        expect(badInputs).to.be.false;
      });

      test('Returns property object with created date', function() {
        const obj = basic.getCreatedDate(properties);
        expect(obj).to.deep.equal(val);

        const badInput = basic.getCreatedDate(null);
        expect(badInput).to.deep.equal({});
      });

      test('Computes if data item is selected', function() {
        const result = basic._computeIsSelected({base: [basic]});
        expect(result).to.be.true;

        const badInput = basic._computeIsSelected({});
        expect(badInput).to.be.false;
      });

      test('Computes if data item is disabled', function() {
        const isDisabled = basic.computeDisabled(false, true);
        expect(isDisabled).to.be.true;

        const isDisabled2 = basic.computeDisabled(false, false);
        expect(isDisabled2).to.be.false;

        const isDisabled3 = basic.computeDisabled(true, true);
        expect(isDisabled3).to.be.false;

        const isDisabled4 = basic.computeDisabled(true, false);
        expect(isDisabled4).to.be.false;
      });

      test('Fires select-item event if item is enabled', function() {
        basic.selectItem({});
        expect(_selectItemSpy).to.have.been.calledOnce;
      });

      test('Render created display property', function() {
        const badInput = basic._computeCreatedDetails();
        expect(badInput).to.equal('');

        const display = basic._computeCreatedDetails('2017-10-14T19:02:16.859335Z');
        expect(display).to.equal('October 14, 2017');
      });

      test('Computes package state', function() {
        const processing = {
          base: {
            state: 'PROCESSING'
          }
        };
        const unavailable = {
          base: {
            state: 'UNAVAILABLE'
          }
        }
        expect(basic._computePackageState(processing)).to.equal('Preparing...');
        expect(basic._computePackageState(unavailable)).to.equal('Preparing...');
        expect(basic._computePackageState({})).to.equal(undefined);
        expect(basic._computePackageState(null)).to.equal(undefined);
      });

      test('Computes whether or not to show package state', function() {
        const processing = {
          base: {
            state: 'PROCESSING'
          }
        };
        const unavailable = {
          base: {
            state: 'UNAVAILABLE'
          }
        }
        expect(basic._computeShowPackageState(processing)).to.be.true;
        expect(basic._computeShowPackageState(unavailable)).to.be.true;
        expect(basic._computeShowPackageState({})).to.be.false;
        expect(basic._computeShowPackageState(null)).to.be.false;
      });

      test('Computes package type details', function() {
        const packageType = basic._computePackageDetails(basic.data);
        expect(packageType, 'DataSet').to.be.equal;

        const badInput = basic._computePackageDetails({});
        expect(badInput, '').to.be.equal;

        const noInput = basic._computePackageDetails(null);
        expect(noInput, '').to.be.equal;
      });

      test('Tracks start of editing data item name', function(done) {
        flush(function() {
          basic.setEditing();
          expect(basic.isEditing).to.be.true;
          expect(basic._name, basic.data.content.name).to.be.equal;
          expect(_setEditingSpy).to.have.been.calledOnce;
          done();
        });
      });

      test('Tracks end of editing data item name only if component has inline editing', function(done) {
        flush(function() {
          basic.stopEditing();
          expect(_renameItemSpy.callCount, 0).to.be.equal;
          done();
        });
      });

      test('Reverts name to original value', function() {
        basic.set('data.content.name', 'test');
        basic.revertName();
        expect(basic.isEditing).to.be.false;
        expect(basic.data.content.name, 'Blackfynn');
      });

      test('Toggles isHovering propery', function() {
        basic._onMouseEnter();
        expect(basic.isHovering).to.be.true;

        basic._onMouseLeave();
        expect(basic.isHovering).to.be.false;
      });

      test('Handles tap events', function() {
        const params = {
          preventDefault: () => {},
          stopPropagation: () => {},
          type: 'tap',
          detail: {
            x: 0,
            y: 0
          }
        };
        basic.openMenu(params);
        expect(_openMenuSpy.callCount, 0).to.be.equal;

        basic.data.content.packageType = 'Collection';
        basic.openMenu(params);
        expect(_openMenuSpy.callCount, 1).to.be.equal;
      });

    });
  </script>

</body>
</html>
