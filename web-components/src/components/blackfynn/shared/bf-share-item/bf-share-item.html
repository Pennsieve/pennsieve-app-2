<link rel="import" href="../../../../vendor-scripts.html">

<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="../../../../config/config.html">
<link rel="import" href="../../shared/bf-dialog/bf-dialog.html">
<link rel="import" href="../../shared/bf-ajax-behavior.html">
<link rel="import" href="../../shared/patched-overlay-behavior.html">
<link rel="import" href="../bf-logger/bf-logger-behavior.html">
<link rel="import" href="../../state/bf-state-aware-behavior.html">

<link rel="import" href="bf-share-item-node.html">
<link rel="import" href="bf-share-search-input.html">

<link rel="import" href="../../../../styles/blackfynn/main.html">
<link rel="import" href="../../../../styles/blackfynn/icons.html">

<!--
  For example:

    <bf-share-item>
    </bf-share-item>

@element bf-share-item
@demo demo/index.html
-->

<dom-module id="bf-share-item">
  <template>
    <style include="blackfynn-main-styles"></style>
    <style>

      :host #dialog {
        width: 560px;
        font-size: 13px;
      }

      :host #dialog [slot="body"] {
        overflow: hidden;
      }

      :host([focused]) {
        outline: none;
      }

      :host([hidden]) {
        display: none !important;
      }
      h3 {
        font-size: 14px;
        margin: 0 0 10px 30px;
      }

      p {
        padding: 0px 0 0 30px;
      }

      a {
        color: var(--dopamine);
      }

      ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }

      .scroll {
        height: 200px;
        overflow-y: auto;
        overflow-x: hidden;
      }

      .shared-with {
        border-top: 1px solid var(--cortex);
      }

      .shared-with section {
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
        height: 130px;
      }

      .shared-with section div {
        width: 55%;
        text-align: center;
      }

      ul.navigation {
        position: absolute;
        z-index: 999;
        width: 100%;
        height: 350px;
      }
      ul.navigation bf-share-item-node:last-of-type {
        box-shadow: 0 1px 0 0 var(--cortex), 0 1px 0 0 var(--cortex), 0 3px 1px 0 rgba(0,0,0,0.1);
      }

      .search-component {
        padding: 15px 20px 30px;
        background: #f9f9f9;
        border-top: 1px solid var(--cortex);
        border-radius: 0px 0px 4px 4px;
      }
      .search-component h3 {
        margin: 0;
      }

      bf-share-item-node {
        border-top: 1px solid var(--cortex);
      }
      bf-share-item-node:first-child {
        border: none;
      }
      bf-share-item-node.single {
        border-bottom: 1px solid var(--cortex);
      }

    </style>

    <!-- PUT /datasets/{id}/collaborators -->
    <iron-ajax
      id="addCollaborators"
      debounce-duration="300"
      method="PUT"
      params="[[ajaxParams]]"
      content-type="application/json"
      url="[[collabApiUrl]]"
      on-error="ajaxError"
      on-response="_onAddCollaborators">
    </iron-ajax>

    <!-- DELETE /datasets/{id}/collaborators -->
    <iron-ajax
      id="deleteCollaborators"
      debounce-duration="300"
      method="DELETE"
      params="[[ajaxParams]]"
      content-type="application/json"
      url="[[collabApiUrl]]"
      on-error="ajaxError"
      on-response="_onDeleteCollaborators">
    </iron-ajax>

    <!-- GET /datasets/{id}/collaborators -->
    <iron-ajax
      id="getCollaborators"
      debounce-duration="300"
      method="GET"
      params="[[ajaxParams]]"
      content-type="application/json"
      url="[[collabApiUrl]]"
      last-response="{{collaborators}}"
      on-error="ajaxError"
      on-response="_handleGetCollaboratorsResponse">
    </iron-ajax>

    <!-- GET /organizations/{id}/members -->
    <iron-ajax
      id="getMembers"
      params="[[ajaxParams]]"
      url="[[membersApiUrl]]"
      last-response="{{members}}"
      on-error="ajaxError"

      method="GET">
    </iron-ajax>

    <!-- GET /organizations/{id}/teams -->
    <iron-ajax
      id="getTeams"
      params="[[ajaxParams]]"
      url="[[teamsApiUrl]]"
      last-response="{{teams}}"
      on-error="ajaxError"

      method="GET">
    </iron-ajax>

    <bf-dialog id="dialog" class="no-padding" opened="{{opened}}" processing="[[processing]]" on-iron-overlay-opened="patchOverlay">
      <h2 slot="heading">[[heading]]</h2>

      <div slot="body">

        <h3>Who has access?</h3>
        <div hidden$="{{!loading}}">
          <center>
            <paper-spinner-lite active$="{{loading}}"></paper-spinner-lite>
          </center>
        </div>

        <div hidden$="{{loading}}">

          <!-- navigation -->
          <ul class="shared-with navigation" hidden$="{{!showNavigationView}}" on-tap="hideShareNavFunc">
            <bf-share-item-node
              nav-item="true"
              class-names="nav-item"
              on-tap="setDataSetToPrivate"
              icon-name="blackfynn:lock"
              _is-owner="[[_isOwner]]">
              <strong>Private</strong> &mdash; Only you can access this.
            </bf-share-item-node>
            <bf-share-item-node
              on-tap="setDataSetToEveryone"
              class-names="nav-item"
              icon-name="blackfynn:organization"
              _is-owner="[[_isOwner]]">
              <strong>[[state.activeOrganization.organization.name]]</strong> &mdash; Your organization can view and manage data.
            </bf-share-item-node>
          </ul>

          <!-- if private ... -->
          <div class="shared-with" hidden$="{{!showPrivateView}}">
            <ul>
              <bf-share-item-node
                event-name="activateShareNav"
                link-text="Change..."
                class="share-list-item single"
                icon-name="blackfynn:lock"
                _is-owner="[[_isOwner]]">
                <strong>Private</strong> &mdash; Only you can access this.
              </bf-share-item-node>
            </ul>
            <section hidden$="[[!_isOwner]]">
              <div>
                Only you can see this dataset right now. Invite other people or <a href="#" on-tap="_showNavigation">change</a> the settings to start sharing.
              </div>
            </section>
          </div>

          <!-- if specific people... -->

          <bf-share-item-node
            hidden$="[[!showPeopleView]]"
            event-name="activateShareNav"
            link-text="Change..."
            class="share-list-item"
            icon-name="blackfynn:lock"
            _is-owner="[[_isOwner]]">
            Specific People...
          </bf-share-item-node>
          <div id="sharedWith" class="shared-with scroll" hidden$="{{!showPeopleView}}">
            <ul>
              <template
                 is="dom-repeat"
                 items="{{_collaborators}}">
                <bf-share-item-node
                  event-name="removeCollaborator"
                  item="[[item]]"
                  link-text="Remove"
                  icon-name="blackfynn:organization"
                  class="share-list-item"
                  data-id$="[[item.id]]"
                  _is-owner="[[_isOwner]]">
                  [[_displayName(item)]]
                </bf-share-item-node>
              </template>
            </ul>
          </div>

          <!-- if everyone... -->
          <div class="shared-with" hidden$="{{!showOrganizationView}}">
            <ul>
              <bf-share-item-node
                event-name="activateShareNav"
                link-text="Change..."
                class="share-list-item single"
                icon-name="blackfynn:organization"
                _is-owner="[[_isOwner]]">
                <strong>[[state.activeOrganization.organization.name]]</strong> &mdash; Your organization can view and manage data.
              </bf-share-item-node>
            </ul>
            <section hidden$="[[!_isOwner]]">
              <div>
                This dataset is shared with your entire organization. You can <a href="#" on-tap="_showNavigation">change</a> the settings to make it private or share with select people or teams.
              </div>
            </section>
          </div>

          <!-- share input -->
          <div class="search-component" hidden$="{{!showSearchComponent}}">
            <h3>Invite people to <strong>[[curPackage.content.name]]</strong></h3>
            <bf-share-search-input
              id="shareSearch"
              active-organization="[[activeOrganization]]"
              api-url="[[collabApiUrl]]"
              ajax-params="[[ajaxParams]]"
              collaborators="{{collaborators}}"
              placeholder-text="Enter names, email addresses, or team names..."
              candidates="{{candidates}}">
            </bf-share-search-input>
          </div>

        </div>
      </div>
    </bf-dialog>

  </template>

  <script>
    Polymer({
      is: 'bf-share-item',

      behaviors: [
        Blackfynn.Config,
        Blackfynn.AjaxBehavior,
        Blackfynn.PatchedOverlayBehavior,
        Blackfynn.LoggerBehavior,
        StateAwareBehavior
      ],

      listeners: {
        'activateShareNav':     '_activateShareNavFunc',
        'removeCollaborator':   '_removeCollaborator',
        'iron-overlay-opened':  '_fetchData',
        'iron-overlay-closed':  '_onClose',
        'add-collaborators': '_onAddCollaborators'
      },

      observers: [
        'changePrivacy(collaborators.*)',
        'enableSearchComponent(views.*)',
        'enablePrivateView(views.private)',
        'enablePeopleView(views.people)',
        'enableOrganizationView(views.organization)'
      ],

      properties: {

        /**
         * Enables Paper Dialog backdrop by default
         */
        withBackdrop: {
          type: Boolean,
          value: true
        },

        /**
         * Current dataset or package
         */
        curPackage: {
          type: Object,
          value: function() { return {} }
        },

        /**
         * Loading state
         */
        loading: {
          type: Boolean,
          value: false
        },

        /**
         * Built object of parameters to send with AJAX requests
         */
        ajaxParams: {
          type: Object,
          computed: '_buildAjaxParams(state.userToken)'
        },

        /*
         * Holds state for available and active views
         */
        views: {
          type: Object,
          value: {
            private:      false,
            people:       false,
            organization: false
          },
          notify: true
        },

        /*
         * Determines if hidden state of view component is Navigation
         */
        showNavigationView: {
          type: Boolean,
          value: false
        },

        /*
         * Determines if hidden state of view component is Private
         */
        showPrivateView: {
          type: Boolean,
          value: false
        },

        /*
         * Determines if hidden state of view component is Specific People
         */
        showPeopleView: {
          type: Boolean,
          value: false
        },

        /*
         * Determines if hidden state of view component is Organization
         */
        showOrganizationView: {
          type: Boolean,
          value: false
        },

        /*
         * Determines if search component should be visible
         */
        showSearchComponent: {
          type: Boolean,
          value: false
        },

        /*
         * Current set of collaborators (users and groups) for this dataset
         */
        collaborators: {
          type: Object,
          notify: true
        },

        _collaborators: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /*
         * List of collaborator candidates
         */
        candidates: {
          type: Array,
          value: []
        },

        /**
         * Root URL for the members of a package, e.g. collaborators
         */
        collabApiUrl: {
          type: String,
          computed: '_buildCollabApiUrl(state.apiUrl, curPackage.content.id)'
        },

        /**
         * Root URL for the members of an organization
         */
        membersApiUrl: {
          type: String,
          computed: '_buildMembersApiUrl(state.apiUrl, state.activeOrganization.organization.id)'
        },

        /**
         * Root URL for the teams of an organization
         */
        teamsApiUrl: {
          type: String,
          computed: '_buildTeamsApiUrl(state.apiUrl, state.activeOrganization.organization.id)'
        },

        /*
         * Determines if the suggestions are refreshing
         */
        isRefreshing: {
          type: Boolean,
          value: false
        },

        /*
         * Members of the organization
         */
        members: {
          type: Array,
          value: []
        },

        /*
         * Compute if the user is the owner of the dataset
         */
        _isOwner: {
          type: Boolean,
          computed: '_computeIsOwner(state.profile.id, curPackage.owner)'
        },

        heading: {
          type: String,
          computed: '_computeHeading(_isOwner, curPackage.content.name)'
        }

      },

      /**
       * Listens to changes on the collaborators property and
       * sets the active view dependent on rules for
       * the collaborators
       */
      changePrivacy: function() {
        // Resize the window
        this.$.dialog.notifyResize();

        if(Object.keys(this.collaborators).length) {
          const groupPresent = this.collaborators.organizations.length > 0;

          // and the users are owner
          // set dataset to group share
          if (groupPresent) {
            this._setActiveViewToOrganization();
            return;
          }

          this._setActiveViewToPrivate();
        }
      },

      /*
       * Compute if the user is the owner of the dataset
       */
      _computeIsOwner: function(id, itemOwner) {
        return id === itemOwner;
      },

      _computeHeading: function(isOwner, packageName) {
        let heading = 'Sharing';
        if(isOwner) {
          heading = `Share ${packageName}`;
        }

        return heading;
      },

      /*
       * Shows the share navigation
       */
      _activateShareNavFunc: function() {
        this.set('showNavigationView', true);
      },

      /*
       * Hides the share navigation
       */
      hideShareNavFunc: function() {
        this.set('showNavigationView', false);
      },

      /**
      * Gets the active view
      */
      _getActiveView: function() {
        let activeView;
        for (let p in this.views) {
          if (this.views[p]) {
            activeView = p;
          }
        }
        return activeView;
      },

      /**
      * Sets the active view
      */
      _setActiveView: function(viewName) {
        if (!this._isValidView(viewName)) {
          return;
        }
        for (let p in this.views) {
          if (this.views.hasOwnProperty(p)) {
            this.set(`views.${p}`, false);
          }
        }
        this.set('showNavigationView', false);
        this.set(`views.${viewName}`, true);
      },

      /**
      * Checks if the view is valid
      */
      _isValidView: function(viewName) {
        if ((R.keys(this.views)).indexOf(viewName) === -1) {
          return false;
        }
        return true;
      },

      /**
      * Checks if the view is active
      */
      _isActiveView: function(viewName) {
        // type check
        if (typeof(viewName) !== 'string') {
          return false;
        }
        if (!this._isValidView(viewName)) {
          return false;
        }
        return this.views[viewName];
      },

      /**
      * Sets the active view to the organization
      */
      _setActiveViewToOrganization: function() {
        this._setActiveView('organization');
      },

      /**
      * Sets the active view to private
      */
      _setActiveViewToPrivate: function() {
        let v = R.isEmpty(this.collaborators.users) && R.isEmpty(this.collaborators.teams) ? 'private' : 'people';
        this._setActiveView(v);
      },

      /**
      * Show the navigation panel
      */
      _showNavigation: function() {
        this.set('showNavigationView', true);
      },

      /**
      * Returns ajax api_key key/value pair
      */
      _buildAjaxParams: R.assoc('api_key', R.__, {}),

      /**
       * Listens to change on views property views.private and
       * updates showPrivateView to toggle component visibility
       */
      enablePrivateView: function() {
        this.set('showPrivateView', this._isActiveView('private'));
      },

      /**
       * Listens to change on views property views.people and
       * updates showPeopleView to toggle component visibility
       */
      enablePeopleView: function() {
        this.set('showPeopleView', this._isActiveView('people'));
      },

      /**
       * Listens to change on views property views.organization and
       * updates showOrganizationView to toggle component visibility
       */
      enableOrganizationView: function() {
        this.set('showOrganizationView', this._isActiveView('organization'));
      },

      /**
       * Listens to change on all views properties and
       * updates showSearchComponent to toggle component visibility
       */
      enableSearchComponent: function() {
        const searchEnabled = (this._isActiveView('private') || this._isActiveView('people')) && this._isOwner;

        return this.set('showSearchComponent', searchEnabled);
      },

      /**
       * Generates the API endpoint for collaborators of a dataset.
       */
      _buildCollabApiUrl: function(apiUrl, curPackageId) {
        return `${apiUrl}/datasets/${curPackageId}/collaborators`
      },

      /**
       * Generates the API endpoint for members of an organization.
       */
      _buildMembersApiUrl: function(apiUrl, orgId) {
        return `${apiUrl}/organizations/${orgId}/members`
      },

      /**
       * Generates the API endpoint for teams of an organization.
       */
      _buildTeamsApiUrl: function(apiUrl, orgId) {
        return `${apiUrl}/organizations/${orgId}/teams`
      },

      /**
       * Fetches all the data for this view of the Paper dialog, runs
       * when the dialog opens.
       */
      _fetchData: function() {
        // Enable loading flag
        this.set('loading', true);

        // Reset collaborators, members, teams, and candidates
        this.set('collaborators', []);
        this.set('_collaborators', []);
        this.set('members', []);
        this.set('teams', []);
        this.set('candidates', []);

        // Get collaborators
        const collaboratorRequest = this.$.getCollaborators.generateRequest();

        // Get members
        const membersRequest = this.$.getMembers.generateRequest();

        // Get teams
        const teamsRequest = this.$.getTeams.generateRequest();

        // Wait for all requests to return
        Promise.all([collaboratorRequest.completes, membersRequest.completes, teamsRequest.completes])
          .then( ([collaboratorResponse, membersResponse, teamsResponse]) => {
              const collaborators = collaboratorResponse.response;
              const members = membersResponse.response;
              const teams = R.pluck('team')(teamsResponse.response);

              const possibleCandidates = members.concat(teams);

              // Get the current user
              const currentUser = R.filter(R.propEq('id', this.state.profile.id), possibleCandidates);

              // Combine current user with collaborators
              const exclusions = [].concat(currentUser, collaborators.teams, collaborators.users);

              // Remove exclusions from possibleCandidates
              const candidates = R.without(exclusions, possibleCandidates);

              this.set('candidates', candidates);

              // Disable loading flag
              this.set('loading', false);

              // Notify resize
              this.$.dialog.notifyResize();
          });
      },

      /**
       * Updates the collaboratorCounts on the dataset so we don't
       * have to fetch the dataset again
       */
      _handleGetCollaboratorsResponse: function(e, detail) {
        this.set('_collaborators', [].concat(this.collaborators.teams, this.collaborators.users));
      },

      /**
       * Cleans up the set of members for selection.
       */
      _handleGetMembersResponse: function(e, detail) {
        let exclusions = R.filter(R.propEq('id', this.state.profile.id))(this.members);

        if (!R.isNil(this.collaborators)) {
          exclusions = exclusions.concat(this.collaborators.users);
        }

        exclusions.forEach(exclusion => {
          if (!exclusion.id) {
            return;
          }
          const index = R.findIndex(R.propEq('id', exclusion.id))(this.members);
          if (index !== -1) {
            this.splice('members', index, 1);
          }
        });

        this.set('candidates', this.candidates.concat(this.members));
      },

      /**
       * Cleans up the set of teams for selection.
       */
      _handleGetTeamsResponse: function(e, detail) {
        const exclusions = R.propOr([], 'teams')(this.collaborators);

        exclusions.forEach(exclusion => {
          const index = R.findIndex(R.pathEq(['team', 'id'], exclusion))(this.teams);
          if (index !== -1) {
            this.splice('teams', index, 1);
          }
        });

        const organizations = R.pluck('team')(this.teams);
        this.set('candidates', this.candidates.concat(organizations));
      },

      /**
      * Invokes the AJAX call to change collaborator set
      */
      addNodesToDataset: function() {
        this._makeRequest(this.$.addCollaborators, [this.state.activeOrganization.organization.id]);
      },

      /**
       * Helper function to make ajax request
       */
      _makeRequest: function(ajaxRequestElement, ids) {
        if (!Array.isArray(ids)) {
          return;
        }
        ajaxRequestElement.body = ids;
        ajaxRequestElement.generateRequest();
      },

      /**
       * Get Node type from ID
       */
      getNodeType: R.compose(
        R.nth(1),
        R.split(':'),
        R.defaultTo('')
      ),

      getCollaborator: function(id) {
        const nodeType = this.getNodeType(id) + 's';
        let collaborator = {};

        // Adding a user
        if(nodeType === 'users') {
          collaborator = R.defaultTo({}, R.find(R.propEq('id', id))(this.members));
        }

        // Adding a team
        if(nodeType === 'teams') {
          collaborator = R.defaultTo({}, R.find(R.pathEq(['team', 'id'], id))(this.teams)).team;
        }

        // Adding an organization
        if(nodeType === 'organizations' && id === this.state.activeOrganization.organization.id) {
          collaborator = this.state.activeOrganization.organization;
        }

        if(Object.keys(collaborator).length <= 0) {
          return null;
        }

        return collaborator;
      },

      _onAddCollaborators: function(e, detail) {
        this.modifyCollaborators('ADD', detail.response);

        // Scroll to the bottom of the list to show the user a member was added
        this.async( () => {
          this.$.sharedWith.scrollTop = this.$.sharedWith.scrollHeight;
        }, 100);
      },

      /**
       * Removes sharing for a user and updates their isCollaborator flag
       * in the members collection to false
       **/
      _removeCollaborator: function(e) {
        const userId = R.pathOr(0, ['detail', 'item', 'id'], e);
        if (userId === 0) {
          return;
        }
        this.removeCollaboratorsFromDataset(userId);
      },

      /**
        * Collects all user IDs from arrays of user nodes;
        * Accepts Array of node objects or Object of Arrays of node objects
       */
      getNodeIds: function(collection) {
        let ids = [];
        let objKeys;

        const getIds = function(arr) {
          return arr.map(function(o) { return o.id; });
        }

        if (!collection.length) {
          // If collection is an object
          objKeys = R.keys(collection);

          if (R.isEmpty(objKeys)) {
            // Not sure what to do here but data structure isn't right
            return ids;
          }

          for (let i = 0; i < objKeys.length; i++) {
            ids = ids.concat(getIds(collection[objKeys[i]]));
          }
        } else {
          ids = getIds(collection);
        }

        return ids;
      },

      /**
        * Collects all the IDs a dataset has been shared with
        * and passes them on for removal
       */
      setDataSetToPrivate: function() {
        const idsToRemove = this.getNodeIds(this.collaborators);
        this.removeCollaboratorsFromDataset(idsToRemove);
      },

      /**
       * Adds the active organization ID to to sharing of
       * the dataset
       */
      setDataSetToEveryone: function() {
        this.addNodesToDataset(this.state.activeOrganization.organization.id);
      },

      /**
       * Passes a list of ids to the deleteCollaborators AJAX request;
       * may be an event if passed along and fired as a removeCollaborator event
       */
      removeCollaboratorsFromDataset: function(ids) {
        if (ids.target) { // ids is probably an event; default to org
          ids = this.state.activeOrganization.organization.id;
        }
        if (!Array.isArray(ids)) {
          ids = new Array(ids);
        }
        this._makeRequest(this.$.deleteCollaborators, ids);
      },

      /**
       * Callback from deleting collaborator
       * @param {Object} Event object
       * @param {Object} XHR response
       */
      _onDeleteCollaborators: function(e, detail) {
        this.modifyCollaborators('DELETE', detail.response);
      },

      modifyCollaborators: function(type, response) {
        // Filter the successfully removed collaborators
        const collaboratorsSuccess = R.filter(R.propEq('success', true))(response.changes);

        const collaborators = Object.keys(collaboratorsSuccess);
        for (let i = 0; i < collaborators.length; i++) {
          // Get collaborator
          const collaborator = this.getCollaborator(collaborators[i]);
          const nodeType = this.getNodeType(collaborators[i]) + 's';

          if(collaborator) {
            if(type === 'ADD') {
              // Remove collaborator from list of candidates
              const index = this.candidates.indexOf(collaborator);
              if(index) {
                this.splice('candidates', index, 1);
              }

              // Add to collaborators
              this.push(`collaborators.${nodeType}`, collaborator);
              this.push(`_collaborators`, collaborator);
            }

            if(type === 'DELETE') {
              // Remove user to list of collaborators
              const index = R.findIndex(R.propEq('id', collaborator.id), this.collaborators[`${nodeType}`]);
              if(index >= 0) {
                this.splice(`collaborators.${nodeType}`, index, 1);
              }

              // Remove collaborator from combined list of collaborators
              const combinedIndex = R.findIndex(R.propEq('id', collaborator.id), this._collaborators);
              if(combinedIndex >= 0) {
                this.splice(`_collaborators`, combinedIndex, 1);
              }

              // Add user from list of candidates
              if(nodeType !== 'organizations') {
                this.push('candidates', collaborator);
              }
            }
          }
        }

        // Notify the info panel of the change
        const updatedCollaborators = Object.assign({}, this.collaborators);
        this.fire('collaborators-updated', {
          itemId: this.curPackage.content.id,
          collaborators: updatedCollaborators,
          counts: response.counts
        });

        // Resize the window
        this.$.dialog.notifyResize();
      },

      /**
       * Builds the display name for the suggestion based on whether
       * team object or user object is passed to the function
       * @param {Object}
       * @return {String}
       */
      _displayName: R.compose(
        R.cond([
          [
            R.converge(R.or, [R.has('firstName'), R.has('lastName')]),
            R.compose(
              R.trim,
              R.join(' '),
              R.props(['firstName', 'lastName'])
            )
          ],
          [R.has('email'), R.prop('email')],
          [R.has('name'), R.prop('name')],
          [R.T, R.always('User')]
        ]),
        R.defaultTo({})
      ),

      /**
       * Callback when the bf-dialog is closed
       */
      _onClose: function() {
        // Reset the share search
        this.$.shareSearch.reset();
      }
    });
  </script>
</dom-module>
