<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="bf-share-item.html">
<link rel="import" href="../../state/bf-state-aware-behavior.html">

<link rel="import" href="../../../../styles/blackfynn/main.html">

<!--
## bf-share-item-label

`<bf-share-item-label>` is a component to display additional information about the data set. Details include the
number of packages within the data set and the amount of storage used.

Currently designed to be used within the `<bf-data-set-item>` component.

@element bf-share-item-label
@demo ./demo/details-demo.html
-->

<dom-module id="bf-share-item-label">

  <template>
    <style include="blackfynn-main-styles"></style>
    <style>
      :host {
        display: block;
        font-size: 13px;
        line-height: 15px;
        padding: 3px 20px;
      }
      a, span.share-item-label {
        color: #71747C;
      }
    </style>

    <span class="share-item-label">
      <template is="dom-if" if="[[userIsOwner]]">
        <a href="#" on-tap="showModal">{{linkText}}</a>
      </template>

      <template is="dom-if" if="[[!userIsOwner]]">
        {{linkText}}
      </template>
    </span>

    <bf-share-item
      id="modal"
      cur-package="{{curPackage}}"></bf-share-item>

  </template>

  <script>
    Polymer({
      is: 'bf-share-item-label',

      behaviors: [
        StateAwareBehavior
      ],

      properties: {

        curPackage: {
          type: Object
        },

        userIsOwner: {
          type: Boolean,
          value: true
        },

        linkText: {
          type: String
        }
      },

      observers: [
        '_buildLinkText(curPackage.*, state.profile.id)'
      ],

      /**
       * Check if dataset is shared
       * @param {Object} collaboratorCounts
       * @returns {Boolean}
       */
       _isShared: function(collaboratorCounts) {
        const collaborators = R.defaultTo({}, collaboratorCounts);
        const totalCount = Object.keys(collaborators).reduce((accum, key) => {
          return accum += collaboratorCounts[key];
        }, 0);
        return totalCount > 0;
      },

      _buildLinkText: function() {
        const curPackage = this.curPackage;
        const counts = curPackage.collaboratorCounts;
        let text = '';
        let sharedWithTeams = false;

        // Current user is not owner of dataset
        if (this.state.profile.id !== curPackage.owner) {
          // Should not be a link; cannot change sharing
          this.set('userIsOwner', false);
          this.set('linkText', text);
        }

        if (!this._isShared(counts)) {
          return 'Not shared';
        }

        text = 'Shared with ';

        // Do organizations take precendent?
        if (counts.organizations && counts.organizations !== 0) {
          text += 'everyone';
        } else {
          // teams
          if (counts.teams && counts.teams > 0) {
            const teamCount = counts.teams;
            sharedWithTeams = true;
            text += `${teamCount} team`;
            if (teamCount > 1) {
              text += 's'; //pluralize
            }
          }
          // users
          if (counts.users && counts.users > 0) {
            const userCount = counts.users;
            if (sharedWithTeams) {
              text += ' and '
            }
            text += `${userCount} user`;
            if (userCount > 1) {
              text += 's'; //pluralize
            }
          }
        }

        this.set('linkText', text);
        return text;
      },

      showModal: function() {
        this.$.modal.set('opened', true);
      }
    })
  </script>

</dom-module>
