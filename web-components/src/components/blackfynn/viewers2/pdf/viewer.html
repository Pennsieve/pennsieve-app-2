<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../shared/bf-viewer-package-title.html">
<link rel="import" href="../../shared/bf-ajax-behavior.html">
<link rel="import" href="../../shared/show-pkg-title-behavior.html">
<link rel="import" href="../static-viewer-behavior.html">

<dom-module id="bf-viewer-pdf">
  <template>
    <style type="text/css">
      :host {
        position: relative;
        width: 100%;
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }
      .pdf-viewer {
        border: none;
        height: 100%;
        width: 100%;
      }
      .overlay {
        background-color: rgba(255, 255, 255, 0.01);
        bottom: 0;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
      }
    </style>

    <template is="dom-if" if="[[showPkgTitle]]">
      <bf-viewer-package-title
        is-active="[[isActive]]"
        title="[[data.name]]"></bf-viewer-package-title>
    </template>

    <div class="overlay" hidden$="[[!isDragging]]"></div><!-- overlay used to capture drag events -->
    <iframe id="frame" class="pdf-viewer" src="[[getFileUrl]]"></iframe>

    <iron-ajax
      auto
      id="getViewerData"
      method="GET"
      url="[[getViewerDataUrl]]"
      loading="{{isLoadingViewerData}}"
      content-type="application/json"
      handle-as="json"
      on-response="_handleGetViewerData"
      on-error="ajaxError"></iron-ajax>

  </template>

  <script>
    Polymer({
      is: 'bf-viewer-pdf',

      properties: {
        /**
         * tracks whether user is dragging an item from the file browser palette
         */
        isDragging: {
          type: Boolean,
          value: false
        },
        /**
         * tracks whether single or split view
         */
        hasSplitView: {
          type: Boolean,
          value: false
        },
        /**
         * tracks whether viewer is active
         */
        isActive: {
          type: Boolean,
          value: false
        }
      },

      behaviors: [
        Blackfynn.StaticViewerBehavior,
        Blackfynn.AjaxBehavior,
        Blackfynn.ShowPkgTitleBehavior
      ],

      listeners: {
        'mouseover': '_onmouseover'
      },

      /**
       * mouseover handler
       * @param {Event} evt
       */
      _onmouseover: function(evt) {
        if (this.hasSplitView && !this.isActive && evt.target.id !== 'frame') {
          this.set('isDragging', true);
        }
      },

      /**
       * Polymer lifecycle event
       */
      attached: function() {
        this.listen(this.$$('.overlay'), 'tap', 'setDragging');
      },

      /**
       * Polymer lifecycle event
       */
      detached: function() {
        this.unlisten(this.$$('.overlay'), 'tap', 'setDragging');
      },

      /**
       * set isDragging property
       */
      setDragging: function() {
        this.set('isDragging', false);
      }

    });
  </script>
</dom-module>
