<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../../../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../../../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../../../../vendor-scripts.html">
<link rel="import" href="../../../../config/config.html">
<link rel="import" href="../bf-ajax-behavior.html">
<link rel="import" href="../bf-share-item/bf-share-item.html">
<link rel="import" href="../bf-icon-circle/bf-icon-circle.html">
<link rel="import" href="../../state/bf-state-aware-behavior.html">

<link rel="import" href="../../../../styles/blackfynn/main.html">
<link rel="import" href="../../../../styles/blackfynn/icons.html">

<!--
## bf-share-information

`<bf-share-information>` is a component to display the users who have been shared on an item.

  For example:

    <bf-share-information
      item="[[item]]"
      user="[[user]]"
      active-organization="[[activeOrganization]]"
      profile="[[profile]]"
      user-id="[[profile.id]]"
      is-owner="[[isOwner]]"></bf-share-information>

@demo
-->

<dom-module id="bf-share-information">

  <template>
    <style include="blackfynn-main-styles"></style>
    <style>
      :host {
        display: block;
      }
      #collaborator-wrap {
        margin-bottom: 10px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      #avatar-wrap {
        margin-right: 17px;
        @apply(--layout-horizontal);
      }
      #avatar-wrap .collaborator {
        margin-right: -12px;
      }
      #overflow {
        color: var(--glial);
      }
      paper-spinner-lite {
        display: block;
        padding-bottom: 4px 0;
      }
      #btn-update {
        display: block;
      }
    </style>

    <template is="dom-if" if="[[!views.private]]">
      <div id="collaborator-wrap" hidden$="[[loading]]">
        <div id="avatar-wrap">
          <template is="dom-repeat" items="[[_collaboratorsTrimmed.items]]">
            <template is="dom-if" if="[[_isUser(item)]]">
              <bf-avatar
                class="collaborator"
                profile="[[item]]"
                tooltip></bf-avatar>
            </template>
            <template is="dom-if" if="[[!_isUser(item)]]">
              <bf-icon-circle class="collaborator">
                <iron-icon icon="blackfynn:organization"></iron-icon>

                <paper-tooltip
                  position="top"
                  offset="5">[[item.name]]</paper-tooltip>
              </bf-icon-circle>
            </template>
          </template>
        </div>

        <div id="overflow" hidden$="[[!hasOverflow]]">+ [[_collaboratorsTrimmed.extra]] more</div>
      </div>
    </template>

    <p class="no-margin" hidden$="[[!views.private]]">Not shared</p>

    <paper-spinner-lite
      active$="[[loading]]"
      hidden$="[[!loading]]"></paper-spinner-lite>

    <a id="btn-update" href="#" on-tap="showShareDialog">[[shareLinkText]]</a>

    <bf-share-item
      id="shareItem"
      cur-package="{{item}}"
      collaborators="{{collaborators}}"
      views="{{views}}"></bf-share-item>

    <iron-ajax
      auto$="[[isDataset]]"
      id="getCollaborators"
      method="GET"
      handle-as="json"
      content-type="application/json"
      url="[[_getCollaboratorsUrl]]"
      loading="{{loading}}"
      on-error="ajaxError"
      on-response="_onGetCollaborators"></iron-ajax>

  </template>

  <script>

    Polymer({
      is: 'bf-share-information',

      behaviors: [
        Blackfynn.AjaxBehavior,
        Blackfynn.Config,
        StateAwareBehavior
      ],

      properties: {
        /**
         * URL for GET collaborators request
         */
        _getCollaboratorsUrl: {
          type: String,
          computed: '_computeGetCollaboratorsUrl(state.apiUrl, item.content.id, state.userToken)'
        },
        /**
         * Collaborators of item
         */
        collaborators: {
          type: Object,
          value: function() {
            return {};
          },
          notify: true
        },
        /**
         * Trimmed list of collaborators of item, based off of maxCollaboratorsShown
         */
        _collaboratorsTrimmed: {
          type: Object,
          value: function() {
            return {
              items: [],
              extra: 0
            };
          }
        },
        /**
         * Total collaborators of item to show
         */
        maxCollaboratorsShown: {
          type: Number,
          value: 5
        },
        /**
         * Number of collaborators is greater than maxCollaboratorsShown
         */
        hasOverflow: {
          type: Boolean,
          computed: '_computeHasOverflow(_collaboratorsTrimmed.extra)'
        },
        /**
         * Loading collaborators
         */
        loading: {
          type: Boolean,
          value: false
        },
        /**
         * Link text based on private or shared
         */
        shareLinkText: {
          type: String,
          computed: '_computeShareLinkText(views.private, isOwner)'
        },
        /**
         * If the item is a datset
         */
        isDataset: {
          type: Boolean,
          value: false
        },
      },

      observers: [
        '_watchCollaborators(collaborators.users.*, collaborators.teams.*)'
      ],

      /**
       * Compute URL for GET collaborators request
       * @param {string} apiUrl
       * @param {string} itemId
       * @param {String} userToken
       * @returns {string}
       */
      _computeGetCollaboratorsUrl: function(apiUrl, itemId, userToken) {
        return `${apiUrl}/datasets/${itemId}/collaborators?api_key=${userToken}`;
      },

      /**
       * Compute collaborators and overflow
       * @param {Array} users
       * @param {Array} groups
       */
      _watchCollaborators: function(users, groups) {
        let _collaborators = R.concat(users.base, groups.base);

        // Add current user if not private
        if(this.views.private === false) {
          _collaborators.push(this.state.profile);
        }

        if(this.views.organization) {
          _collaborators = this.collaborators.organizations;
        }

        let extra = _collaborators.length - this.maxCollaboratorsShown;

        this.set('_collaboratorsTrimmed', {
          items: _collaborators.slice(0, this.maxCollaboratorsShown),
          extra
        });
      },

      /**
       * Compute if number of collaborators is greater than maxCollaboratorsShown
       * @param {number} extra - number of extra collaborators after maxCollaboratorsShown
       * @returns {boolean}
       */
      _computeHasOverflow: function(extra) {
        return extra > 0;
      },

      /**
       * Link text based on private or shared
       * @param {boolean} viewsPrivate
       * @param {boolean} isOwner
       * @returns {string}
       */
      _computeShareLinkText: function(viewsPrivate, isOwner) {
        let linkText = 'Update sharing';

        if(viewsPrivate) {
          linkText = 'Share this dataset with others';
        }

        if(!isOwner) {
          linkText = 'View all collaborators';
        }

        return linkText;
      },

      /**
       * Handle response for GET collaborators
       * @param {Object} Event object
       * @param {Object} detail - xhr response
       */
      _onGetCollaborators: function(e, detail) {
        this.set('collaborators', detail.response);
      },

      /**
       * Show the share dialog
       * @param {Object} Event object
       * @param {Object} detail - xhr response
       */
      showShareDialog: function(e, detail) {
        this.$.shareItem.$.dialog.open();
      },

      /**
       * Compute if item is a user
       * @param {Object} item - collaborator
       * @returns {boolean}
       */
      _isUser: function(item) {
        return item && R.match(/:user:/, item.id).length === 1;
      },

      /**
       * Event from bf-share-item notifying when collaborators has been modified
       * @param {Object} detail - type, dataset and collaborators modified
       */
      updateCollaborators: function( detail ) {
        // Only continue if the sharing information item is currently referencing the dataset being modified
        if(detail.itemId !== this.item.content.id) {
          return;
        }

        this.set('collaborators', detail.collaborators);
      }
    });

  </script>

</dom-module>
