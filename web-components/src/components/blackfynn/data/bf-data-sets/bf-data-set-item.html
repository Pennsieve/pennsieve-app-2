<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../item-label.html">

<link rel="import" href="../../../../styles/blackfynn/main.html">
<link rel="import" href="../../../../styles/blackfynn/data-item.html">
<link rel="import" href="../../../../styles/blackfynn/icons.html">

<link rel="import" href="../../shared/filetype-mapper-behavior.html">
<link rel="import" href="../../shared/bf-share-item/bf-share-item-label.html">
<link rel="import" href="../bf-data-item-behavior.html">
<link rel="import" href="./bf-data-set-item-label.html">
<link rel="import" href="./bf-data-set-item-details.html">

<link rel="import" href="../../../../vendor-scripts.html">

<!--
## bf-data-set-item

`<bf-data-set-item>` is a component to display an individual package.

@element bf-data-set-item
@demo ./demo/data-item-demo.html
-->

<dom-module id="bf-data-set-item">

  <template>

    <style include="blackfynn-main-styles"></style>
    <style include="bf-data-item-styles"></style>
    <style>
      :host {
        background-color: inherit;
        border: 1px solid var(--cortex);
        border-radius: 5px;
        box-shadow: 0px 1px 3px -1px rgba(112, 115, 124, 0.6);
        box-sizing: border-box;
        display: block;
        height: 164px;
        margin: 0 30px 30px 0;
        overflow: hidden;
        position: relative;
        transition: all .1s linear;
        width: 360px;
      }
      :host([hidden]) {
        display: none;
      }
      :host([is-selected]), :host(:hover) {
        box-shadow: 0px 6px 4px 0 rgba(112, 115, 124, 0.25);
      }
      :host([is-selected]) {
        border: 1px solid #aeaeae;
      }
      :host(.item) {
        @apply(--item);
      }
      :host.item:hover {
        @apply(--item-hover);
      }
      :host.converting {
        opacity: .5;
      }
      .data-set-menu-container {
        margin: 6px 10px -7px 0;
        @apply(--layout-flex);
        @apply(--layout-vertical);
        @apply(--layout-end);
      }
      .data-set-menu {
        color: var(--glial);
        cursor: pointer;
        --iron-icon-height: 18px;
        --iron-icon-width:  18px;
      }
    </style>

    <div class="data-set-menu-container">
      <iron-icon
        class="data-set-menu"
        hidden$="[[_isDataSet]]"
        icon="blackfynn:more-h"
        on-tap="_showDetails"></iron-icon>
    </div>

    <bf-data-set-item-label
      id="itemLabel"
      name="[[data.content.name]]"
      is-editing="[[isEditing]]"
      is-hovering$="[[isHovering]]"></bf-data-set-item-label>

    <bf-share-item-label
      cur-package="{{data}}"></bf-share-item-label>

    <bf-data-set-item-details
      storage-metrics="[[_computeStorage(data.storage)]]"
      data-id="[[data.content.id]]"></bf-data-set-item-details>

  </template>

  <script>

    Polymer({
      is: 'bf-data-set-item',

      behaviors:[
        Blackfynn.FileTypeMapperBehavior,
        Blackfynn.DataItemBehavior
      ],

      properties: {
        /**
         * Package data
         */
        data: {
          type: Object,
          value: function() {
            return {};
          }
        },
        /**
         * Boolean to track which is selected by the user
         */
        isSelected: {
          type: true,
          value: false,
          reflectToAttribute: true,
          computed: '_computeIsSelected(selected.*)'
        },
        /**
         * Compute if the package is a Collection or DataSet
         */
        _isCollection: {
          type: Boolean,
          computed: '_computeIsCollection(data.content.packageType, nodeTypes)'
        },
        /**
         * Tracks mouseenter and mouseleave events for data set items
         */
        isHovering: {
          type: Boolean,
          value: false
        },
        /**
         * available raw storage metrics for org's datasets
         */
        storageMetrics: {
          type: Object,
          value: {}
        },
      },

      listeners: {
        'open-item': '_onOpenItem',
        'mouseenter': '_onMouseEnter',
        'mouseleave': '_onMouseLeave',
        'showDetails': '_showDetails',
      },

      /**
       * Passes down whole number for storage display
       * @param {Number}
       * @return {Number}
       */
      _computeStorage: R.defaultTo(0),

      /**
       * Determines whether or not to package is selected
       * @param {Object} selected
       * @return {Boolean}
       */
      _computeIsSelected: function(selected) {
        return (selected.base.indexOf(this) !== -1) ? true : false;
      },

      /**
       * Dispatches an event to track which package the user has clicked on
       * @param {Object} Event Object
       */
      selectItem: function(e) {
        const sourceEvent = R.pathOr({}, ['detail', 'sourceEvent'], e);
        const metaKey = Boolean(sourceEvent.metaKey);
        const shiftKey = Boolean(sourceEvent.shiftKey);

        this.fire('select-item', { item: this, metaKey, shiftKey });
        this.fire('items-selected');
      },

      /**
       * Displays package contents
       * @param {Object} Event Object
       */
      _onOpenItem: function(e) {
        // save current dataset in state to prepend to breadcrumb
        this.fire('set-state-path', {
          path: 'curDataSet',
          state: this.data
        });
        this.fire('update-cur-dataset', { dataset: this.data });

        // Open the dataset
        this.fire('open-dataset', { data: this.data.content });
        // Remove selected item
        this.fire('items-selected');
      },

      /**
       * Sets isHovering property to `true` on mouseenter
       */
      _onMouseEnter: function() {
        this.set('isHovering', true);
      },

      /**
       * Sets isHovering property to `false` on mouseleave
       */
      _onMouseLeave: function() {
        this.set('isHovering', false);
      },

      /**
       * Selects data item and dispatches an event to open the info panel
       */
      _showDetails: function(e) {
        this.selectItem(e);
        this.fire('view-info-panel', {item: this.data});
        this.fire('set-state-path', {
          path: 'curDataSet',
          state: this.data
        });

        this.fire('update-cur-dataset', { dataset: this.data });
      },
    });

  </script>
</dom-module>
