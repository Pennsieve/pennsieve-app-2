<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../../../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../shared/unique-name-behavior.html">
<link rel="import" href="../../shared/bf-dialog/bf-dialog.html">
<link rel="import" href="../../shared/bf-input/bf-input.html">
<link rel="import" href="../../shared/patched-overlay-behavior.html">
<link rel="import" href="../../shared/bf-ajax-behavior.html">
<link rel="import" href="../../state/bf-state-aware-behavior.html">
<link rel="import" href="../../../../styles/blackfynn/main.html">
<link rel="import" href="../../../../vendor-scripts.html">

<!--
## bf-collection-dialog

`<bf-collection-dialog>` is the dialog that allows the user create a collection.
-->

<dom-module id="bf-collection-dialog">

  <template>
    <style include="blackfynn-main-styles"></style>
    <style>
      #dialog {
        max-width: 500px;
        min-width: 500px;
      }
      #inputName {
        margin-bottom: 0;
      }
    </style>

    <bf-dialog id="dialog" opened="{{opened}}" processing="[[processing]]" on-iron-overlay-opened="patchOverlay">
      <h2 slot="heading">[[headingDisplayText]]</h2>

      <div slot="body">
        <bf-input
          id="inputName"
          placeholder="Name"
          label="Name"
          hide-label
          autofocus
          value="{{name}}"
          invalid="{{invalid}}"
          show-invalid>
            <div slot="helper">Name must be unique</div>
          </bf-input>
      </div>

      <div slot="buttons">
        <paper-button
          class="save"
          noink
          hidden$="[[processing]]"
          on-tap="createUpdateCollection">[[buttonDisplayText]]</paper-button>
      </div>
    </bf-dialog>

    <iron-ajax
      id="createUpdateXhr"
      method="[[collectionMethod]]"
      content-type="application/json"
      handle-as="json"
      loading="{{processing}}"
      url="[[collectionUrl]]"
      on-response="_handleCreateUpdate"
      on-error="ajaxError"></iron-ajax>

    <iron-a11y-keys
      keys="enter"
      target="[[keyTarget]]"
      on-keys-pressed="createUpdateCollection"></iron-a11y-keys>

  </template>

  <script>

    Polymer({
      is: 'bf-collection-dialog',

      behaviors: [
        Blackfynn.PatchedOverlayBehavior,
        Blackfynn.UniqueNameBehavior,
        Blackfynn.AjaxBehavior,
        StateAwareBehavior
      ],

      properties: {
        /**
         * Displays heading text
         */
        headingDisplayText: {
          type: String,
          computed: '_computeHeadingDisplayText(selectedItem.content.packageType)',
          value: `Create a collection`
        },
        /**
         * Displays button text
         */
        buttonDisplayText: {
          type: String,
          computed: '_computeButtonDisplayText(selectedItem.content.packageType)',
          value: `Create collection`
        },
        /**
         * All packages within collection
         */
        packages: {
          type: Array,
          value: function() {
            return []
          }
        },
        /**
         * current package information
         */
        curPackage: {
          type: Object,
          value: function() {
            return {};
          }
        },
        /**
         * Show or hide the move item dialog
         */
        opened: {
          type: Boolean,
          value: false,
          notify: true
        },
        /**
         * Compute the endpoint URL for creating a collection
         */
        collectionUrl: {
          type: String,
          computed: '_computeCollectionUrl(state.apiUrl, state.userToken, selectedItem.*)'
        },
        /**
         * Compute the endpoint method for creating or updating a collection
         */
        collectionMethod: {
          type: String,
          computed: '_computeCollectionMethod(selectedItem.content.id)'
        },
        /**
         * Compute the endpoint URL for creating a collection
         */
        processing: {
          type: Boolean,
          value: false,
          notify: true
        },
        /**
         * Target for keyboard functionality
         */
        keyTarget: {
          type: Object,
          value: function() {
            return this.$.inputName;
          }
        },
        /**
         * Selected data item
         */
        selectedItem: {
          type: Object,
          value: function() {
            return {};
          }
        },
        /**
         * possible node types
         */
        nodeTypes: {
          type: Array,
          value: [
            'collection',
            'dataset'
          ]
        },
      },

      listeners: {
        'dialog.iron-overlay-opened': '_onOpened',
        'dialog.iron-overlay-closed': '_onClosed'
      },

      /**
       * Get type of package to display
       * @param {String} packageType
       * @returns {String}
       */
      getType: function(packageType) {
        const _packageType = R.defaultTo('', packageType);
        let type = `collection`;

        if(_packageType && _packageType !== `Collection`) {
          type = `package`;
        }

        return type;
      },

      /**
       * Computes the dialog heading display text
       * @param {String} packageType
       * @returns {String}
       */
      _computeHeadingDisplayText: function(packageType) {
        const type = this.getType(packageType);
        return packageType ? `Rename ${type}` : `Create a ${type}`
      },

      /**
       * Computes the button display text
       * @param {String} packageType
       * @returns {String}
       */
      _computeButtonDisplayText: function(packageType) {
        const type = this.getType(packageType);
        return packageType ? `Update ${type}` : `Create ${type}`
      },

      /**
       * Computes the API method
       * @param {String} selectedId
       * @returns {String}
       */
      _computeCollectionMethod: function(selectedId) {
        return selectedId ? `PUT` : `POST`;
      },

      /**
       * Computes the url for PUT or POST
       * @param {String} selectedId
       * @returns {String}
       */
      _computeCollectionUrl: function(api, user, selectedItem) {
        const selected = selectedItem.value;
        if (!selected.content) {
          return `${api}/packages?api_key=${user}`;
        }

        const id = selected.content.id ? `/${selected.content.id}` : '';
        const packageType = R.pathOr('dataset', ['content', 'packageType'], selected);

        let fileType = packageType.toLowerCase();
        if(this.nodeTypes.indexOf(fileType) === -1 || fileType === 'collection') {
          fileType = 'package';
        }

        return `${api}/${fileType}s${id}?api_key=${user}`;
      },

      /**
       * Handles iron-overlay-opened event; Focuses the input field
       */
      _onOpened: function() {
        const name = R.pathOr('', ['content', 'name'])(this.selectedItem);
        this.set('name', name);
        this.async(() => this.$$('bf-input').$.input.focus(), 100);
      },

      /**
       * Handles iron-overlay-closed event; Resets the name property
       */
      _onClosed: function() {
        this.set('name', '');
        this.set('invalid', false);
        this.set(`selectedItem`, {});
      },

      /**
       * Generates request to update or create a new collection
       */
      createUpdateCollection: function() {
        // Don't do anything if the name is empty
        if(this.name === '' || this.name === undefined) {
          return;
        }
        const ajax = this.$.createUpdateXhr;

        // Check for unique key name
        const isUnique = this.checkUniqueName(this.packages, ['content', 'name'], this.name, '');
        if (isUnique === false && ajax.method === 'POST') {
          return this.set('invalid', true);
        }
        this.set('invalid', false);

        // Set the request's body
        const parent = R.pathOr('', ['content', 'id'])(this.curPackage);
        const datasetId = R.pathOr('', ['content', 'datasetId'])(this.curPackage);

        let collectionParams = {
          name: this.name
        };
        if(Object.keys(this.get(`selectedItem`)).length === 0) {
          collectionParams[`packageType`] = `Collection`;
        }

        let dataParams = {
          parent,
          dataset: datasetId
        };

        if(this.curPackage.content.packageType === 'DataSet') {
          dataParams = {
            dataset: parent
          }
        }

        const requestBody = Object.assign({}, collectionParams, dataParams);

        const selectedItemId = R.path(['content', 'id'])(this.selectedItem);
        ajax.body = selectedItemId ? R.dissoc('parent', requestBody) : requestBody;
        ajax.generateRequest();
      },

      /**
       * Handles successful PUT or POST for collection
       * @param {Event} e
       */
      _handleCreateUpdate: function(e) {
        const selectedId = R.path(['content', 'id'])(this.selectedItem);
        if (selectedId) {
          this.fire('rename-item', e.detail.response);
        } else {
          this.fire('add-collection', { item: e.detail.response });
        }

        // Close the overlay
        this.set('opened', false);
      }
    });

  </script>
</dom-module>
