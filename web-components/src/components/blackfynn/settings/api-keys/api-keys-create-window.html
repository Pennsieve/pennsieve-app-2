<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../shared/bf-dialog/bf-dialog.html">
<link rel="import" href="../../shared/bf-input/bf-input.html">
<link rel="import" href="../../shared/patched-overlay-behavior.html">
<link rel="import" href="../../shared/bf-ajax-behavior.html">
<link rel="import" href="../../state/bf-state-aware-behavior.html">
<link rel="import" href="../../shared/unique-name-behavior.html">

<link rel="import" href="../../../../styles/blackfynn/main.html">

<!--
# api-keys-create-window
Component that handles create operations for client's API keys.

@element api-keys-create-window
-->
<dom-module id="api-keys-create-window">

  <template>
    <style include="blackfynn-main-styles"></style>
    <style type="text/css">
      :host {
        display: block;
      }
    </style>

    <bf-dialog id="dialog" on-iron-overlay-opened="patchOverlay" opened="{{opened}}" processing="[[processing]]">
      <h2 slot="heading">Create an API Key</h2>

      <div slot="body">
        <bf-input id="keyName" label="API Key Name" value="{{name}}" invalid="{{invalid}}" autocapitalize="true" required="true" autofocus="true" show-invalid>
          <div slot="helper">Key names must be unique</div>
        </bf-input>
      </div>

      <div slot="buttons">
        <paper-button hidden$="[[processing]]" class="save" on-tap="_saveKey" noink>Save</paper-button>
      </div>
    </bf-dialog>

    <iron-ajax
      id="saveKey"
      method="POST"
      handle-as="json"
      loading="[[processing]]"
      content-type="application/json"
      url="[[_saveKeyUrl]]"
      on-error="ajaxError"
      on-response="_handleKeySaved"></iron-ajax>

    <iron-a11y-keys keys="enter" on-keys-pressed="_saveKey"></iron-a11y-keys>
  </template>

  <script>
    Polymer({
      is: 'api-keys-create-window',

      behaviors: [
        StateAwareBehavior,
        Blackfynn.AjaxBehavior,
        Blackfynn.PatchedOverlayBehavior,
        Blackfynn.UniqueNameBehavior
      ],

      properties: {
        /**
         * list of keys for user
         */
        keys: {
          type: Object,
          value: function() {
            return [];
          }
        },
        /**
         * name of the key
         */
        name: {
          type: String
        },
        /**
         * tracks whether or not form is processing
         */
        processing: {
          type: Boolean,
          value: false
        },
        /**
         * tracks whether or not bf-dialog is open
         */
        opened: {
          type: Boolean,
          value: false
        },
        /**
         * computes api endpoint for save
         */
        _saveKeyUrl: {
          type: String,
          computed: '_computeKeyUrl(state.apiUrl, state.userToken)'
        },
        /**
         * key name is invalid
         */
        invalid: {
          type: Boolean,
          value: false
        },
      },

      listeners: {
        'dialog.iron-overlay-closed': '_onClose'
      },

      /**
       * Performs necessary tasks when dialog is closed
       */
      _onClose: function() {
        // Clear inputs
        this.set('name', '');
        this.set('invalid', false);
        this.fire('open-api-keys-info-window');
      },

      /**
       * Builds endpoint for POST
       * @param {String} api
       * @param {String} user
       * @returns {String}
       */
      _computeKeyUrl: function(api, user) {
        return `${api}/token?api_key=${user}`;
      },

      /**
       * Builds query and creates key
       */
      _saveKey: function() {
        if (!Boolean(this.name)) {
          return;
        }

        // Check for unique key name
        const isUnique = this.checkUniqueName(this.keys, ['name'], this.name, '');
        if (isUnique === false) {
          this.set('invalid', true);
          return;
        }

        this.set('invalid', false);
        this.set('processing', true);

        this.$.saveKey.body = { name: this.name };
        this.$.saveKey.generateRequest();
      },

      /**
       * Handle sucessful AJAX query
       * @param {Object} e
       */
      _handleKeySaved: function(e) {
        this.set('processing', false);
        this.fire('created-api-key', e.detail.response);
        this.$.dialog.close();
      },

    });
  </script>

</dom-module>
