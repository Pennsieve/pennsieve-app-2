<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../shared/bf-avatar/bf-avatar.html">
<link rel="import" href="../../shared/vuex-behavior/vuex-behavior.html">

<link rel="import" href="../../../../styles/blackfynn/main.html">

<script src="../../../../../bower_components/moment/min/moment.min.js"></script>

<!--
## bf-discussion-comment

`<bf-discussion-comment>` is a component that wraps a discussion.

@demo
-->

<dom-module id="bf-discussion-comment">

  <template>
    <style include="blackfynn-main-styles"></style>
    <style type="text/css">
      :host {
        font-size: 13px;
        padding: 0 15px 10px 10px;
        @apply(--layout-vertical);
      }
      :host(:not(:last-of-type)) #commentBody:before {
        background: var(--cortex);
        content: '';
        display: block;
        height: calc(100% + 20px);
        left: 15px;
        position: absolute;
        top: -10px;
        width: 2px;
      }
      #userInfo {
        margin-bottom: 10px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      bf-avatar {
        margin-right: 10px;
        --bf-icon-circle: {
          height: 32px;
          width: 32px;
        }
      }
      #userName {
        font-weight: 500;
        margin-right: 5px;
      }
      #timestamp {
        color: var(--glial);
        font-size: 12px;
      }
      #commentBody {
        padding-left: 43px;
        position: relative;
      }
      #controls {
        color: var(--glial);
        margin-top: 5px;
        opacity: 0;
        visibility: hidden;
      }
      #controls[hovered] {
        opacity: 1;
        visibility: visible;
      }
      #message span {
        color: var(--dopamine);
      }
    </style>

    <div id="userInfo">
      <bf-avatar profile="[[commentCreator]]"></bf-avatar>
      <span id="userName">[[commentCreatorFirstName]] [[commentCreatorLastName]]</span>
      <span id="timestamp">[[_timestamp.date]] &#8226; [[_timestamp.time]]</div>
    </div>

    <div id="commentBody">
      <div id="message"></div>
      <ul class="dot-list" id="controls" hovered$="[[isHovered]]">
        <li><a href="#" class="plain" on-tap="reply">Reply</a></li>
        <li hidden$="[[!_isOwner]]"><a href="#" class="plain" on-tap="remove">Remove</a></li>
      </ul>
    </div>

  </template>

  <script>
    Polymer({
      is: 'bf-discussion-comment',

      behaviors: [
        Blackfynn.VuexBehavior
      ],

      properties: {
        /**
         * Comment
         */
        comment: {
          type: Object,
          value: function() {
            return {};
          }
        },
        /**
         * Comment creator object
         */
         commentCreator: {
          type: Object,
          computed: '_computeCreator(userMap, comment.creator_id, vuex.profile)'
        },
        /**
         * Comment creator first name
         */
         commentCreatorFirstName: {
          type: String,
          computed: '_computeCreatorFirstName(userMap, comment.creator_id, vuex.profile.firstName)'
        },
        /**
         * Comment creator last name
         */
         commentCreatorLastName: {
          type: String,
          computed: '_computeCreatorLastName(userMap, comment.creator_id, vuex.profile.lastName)'
        },
        /**
         * User Map
         */
         userMap: {
          type: Object,
          value: function() {
            return {};
          }
        },
        /**
         * Compute if the user is the owner of the comment
         */
        _isOwner: {
          type: Boolean,
          computed: '_computeIsOwner(vuex.profile.id, comment.creator_id)'
        },
        /**
         * Compute timestamp
         */
        _timestamp: {
          type: String,
          computed: '_computeTimestamp(comment.updatedAt)'
        }
      },

      /**
       * Compute the comment creator
       * @param {Object} userMap
       * @param {String} creatorId
       * @param {Object} profile
       */
      _computeCreator(userMap, creatorId, profile) {
        const user = userMap[creatorId]
        return R.defaultTo(profile, user);
      },

      /**
       * Compute the comment creator's first name
       * @param {Object} userMap
       * @param {String} creatorId
       * @param {String} profileFirstName
       */
       _computeCreatorFirstName(userMap, creatorId, profileFirstName) {
        const firstName = R.path([creatorId, 'firstName'], userMap);
        return R.defaultTo(profileFirstName, firstName);
      },

      /**
       * Compute the comment creator's last name
       * @param {Object} userMap
       * @param {String} creatorId
       * @param {String} profileLastName
       */
       _computeCreatorLastName(userMap, creatorId, profileLastName) {
        const lastName = R.path([creatorId, 'lastName'], userMap);
        return R.defaultTo(profileLastName, lastName);
      },

      /**
       * Compute if the user is the owner of the comment
       * @param {String} profileId
       * @param {String} creatorId
       */
      _computeIsOwner: function(profileId, creatorId) {
        return profileId === creatorId;
      },

      /**
       * Compute if the user is the owner of the comment
       * @param {Date} timestamp
       * @return {Object}
       */
      _computeTimestamp: function(timestamp) {
        const day = 86400000;
        const now = Date.now();
        const timeDiff = now - timestamp;
        const time = moment(timestamp).utc().format('h:mm A');

        let date = '';

        if(timeDiff < day) {
          date = 'Today';
        } else if(timeDiff > day && timeDiff < day * 2) {
          date = 'Yesterday'
        } else {
          date = moment(timestamp).utc().format('MMMM D, YYYY');
        }

        // Return date object
        // Objects with separate properties to display HTML in betwen values
        return {
          date,
          time
        }
      },


      getName: R.compose(R.replace('[', ''), R.head),
      getId: R.compose(R.replace(')', ''), R.last),

      /**
       * Find mentions and convert them to HTML
       * @param {String} comment
       * @returns {Object}
       */
      findMentions: function(comment) {
        const transform = comment.map( (mention) => {
          const parts = mention.split('](');

          const transformed = parts.length > 0 ? `<span class="mention" id="${this.getId(parts)}">${this.getName(parts)}</span>` : '';

          return {
            raw: mention,
            transformed
          }
        });

        return transform;
      },

      /**
       * Transform comment to replace mentions with styled usernames
       * @param {String} comment
       * @param {Object} mentions
       * @returns {String}
       */
      transformComment: (comment, mentions) => {
        mentions.forEach( ( mention) => {
          comment = comment.replace(mention.raw, mention.transformed);
        });

        return comment;
      },

      /**
       * Attached lifecycle
       */
      attached: function() {
        const message = this.get('comment.message');
        const filteredMentions = message.match(/\[(.*?)\]\((.*?)\)/g);

        if(filteredMentions) {
          const mentions = this.findMentions(filteredMentions);

          const transformedComment = this.transformComment(message, mentions);

          this.$.message.innerHTML = transformedComment;
        } else {
          this.$.message.innerHTML = message;
        }
      },

      /**
       * Remove comment from discussion
       */
      remove: function() {
        this._onRemove();
      },

      /**
       * Callback on ajax remove comment
       * @param {Object} Event object
       * @param {Object} XHR response
       */
      _onRemove: function(e, detail) {
        this.fire('remove-comment', {
          comment: this.comment
        });
      },

      /**
       * Reply to the discussion
       */
      reply: function() {
        this.fire('set-replying', { replying: true });
      },
    });

  </script>

</dom-module>
