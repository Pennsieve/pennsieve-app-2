<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../../../bower_components/iron-a11y-keys/iron-a11y-keys.html">

<link rel="import" href="../../shared/bf-input/bf-textarea.html">
<link rel="import" href="../../shared/bf-input/bf-input.html">
<link rel="import" href="../../shared/bf-input/bf-checkbox.html">
<link rel="import" href="../../shared/bf-select-menu/bf-select-menu.html">
<link rel="import" href="../../shared/bf-dialog/bf-dialog.html">

<link rel="import" href="../../../../styles/blackfynn/main.html">

<dom-module id="bf-ts-filter-window">
  <template>
    <style include="blackfynn-main-styles"></style>
    <style type="text/css">
      :host {
        display: block;
        box-sizing: border-box;
      }
      .select-wrapper {
        border-left: 5px solid var(--dopamine)
      }
      #layerSelect {
        margin: 0 0 10px;
        width: auto;
      }
      .channels-icon {
        border: 1px solid var(--light-gray);
        border-radius: 2px;
        color: var(--light-gray);
        margin-right: 5px;
      }
      .button-wrapper {
        @apply(--layout-horizontal);
        @apply(--layout-justified);
        @apply(--layout-center);
      }
      .channelsSelected {
        margin-right: 20px;
      }
      h2 {
        margin: 20px 30px 30px 30px;
      }
    </style>

    <bf-dialog id="dialog" opened="{{opened}}" processing="[[processing]]">
      <h2 slot="heading">[[_heading]]</h2>

      <div slot="body">
        <div class="select-wrapper">
          <bf-select-menu
            id="filterSelect"
            selected-value="{{selectedFilterId}}"
            items="[[_filters]]"></bf-select-menu>
        </div>
        <bf-input
        hidden$="{{input0Visible}}"
          label="Add a description."
          hide-label
          type="number"
          placeholder="{{placeholder1}}"
          value="{{input0}}"
          allowed-pattern="[0-9]"
          pattern="[0-9]"
          auto-validate="true"></bf-input>

        <bf-input
          autovalidate
          validate= false
          hidden$="{{input1Visible}}"
          label="Add a description."
          hide-label
          type="number"
          placeholder="{{placeholder2}}"
          value="{{input1}}"
          allowed-pattern="[0-9]"
          pattern="[0-9]"
          auto-validate="true"></bf-input>
          <div>
          <bf-select-menu
            hidden$="{{input2Visible}}"
            id="notchSelect"
            selected-value="{{selectedNotchId}}"
            items="[[_notchValues]]"></bf-select-menu>
          </div>
      </div>

      <div slot="buttons">
        <div class="button-wrapper">
          <div class="channelsSelected">
            <template is="dom-if" if="[[onSingleChannel]]">
              <iron-icon class="channels-icon" icon="blackfynn:selection"></iron-icon> Adding to single channel
            </template>
            <template is="dom-if" if="[[!onSingleChannel]]">
              <iron-icon class="channels-icon" icon="blackfynn:selection"></iron-icon> Adding to [[selectedChannels]] Selected Channels
            </template>
          </div>
          <div class="buttons">
          <paper-button
            class="save"
            noink
            hidden$="[[processing]]"
            on-tap="submitForm">[[_buttonText]]</paper-button>
          </div>
        </div>

      </div>
    </bf-dialog>

    <iron-a11y-keys
      keys="enter"
      target="[[_this]]"
      on-keys-pressed="submitForm"></iron-a11y-keys>
  </template>

  <script>

    Polymer({
      is: 'bf-ts-filter-window',

      properties: {
        /**
         * List of channels
         */
        onChannels: {
          type: Array,
          value: function() {
            return [];
          }
        },
        /**
         * True if on single channel
         */
        onSingleChannel: {
          type: Boolean,
          computed: '_computeOnSingleChannel(onChannels)'
        },
        /**
        * Filter variable 1
        */
        input0: {
          type: Number,
          value: NaN
        },
        /**
        * Filter variable 2
        */
        input1: {
          type: Number,
          value: NaN
        },
        /**
         * Compute if the user has entered a description
         */
        _validateFilter: {
          type: Boolean,
          computed: '_computeValidateFilter(input0, input1, selectedFilterId, selectedNotchId)'
        },
        /**
         * This component
         */
        _this: {
          type: Object,
          value: function() {
            return this;
          }
        },
        /**
         * If the request is being processed
         */
        processing: {
          type: Boolean,
          value: false
        },
        /**
         * Returns number of channels
         */
        selectedChannels: {
          type: Number,
          computed: '_computeNrChannels(onChannels)'
        },
        /**
         * Selected value for list Filter types
         */
        selectedFilterId: {
          type: String
        },
        /**
         * Selected value for list Notch
         */
        selectedNotchId: {
          type: Number
        },
        /**
         * Computed layers list for the select menu
         */
        _filters: {
          type: Array,
          value: [
            {
              label: 'No Filter',
              value: 'clear'
            },
            {
              label: 'Low Pass',
              value: 'lowpass'
            },
            {
              label: 'High Pass',
              value: 'highpass'
            },
            {
              label: 'Band Pass',
              value: 'bandpass'
            },
            {
              label: 'Notch',
              value: 'bandstop'
            }
          ]
        },
        /**
         * List of possible notch filters
         */
        _notchValues: {
          type: Array,
          value: [
            {
              label: '50Hz',
              value: 50
            },
            {
              label: '60Hz',
              value: 60
            }
          ]
        },
        /**
         * Compute color for the selected layer
         */
        _layerColor: {
          type: String,
          computed: '_computeLayerColor(selectedLayerId, layers.*)'
        },
        /**
         * If the user is creating an annotation
         */
        isCreating: {
          type: Boolean,
          value: true
        },
        /**
         * Compute heading
         */
        _heading: {
          type: String,
          computed: '_computeHeading(isCreating)'
        },
        /**
         * Compute button text
         */
        _buttonText: {
          type: String,
          computed: '_computeButton(isCreating)'
        },
        /**
         * Placeholder for first input string
         */
        placeholder1: {
          type: String,
          computed: '_computePlaceholder1(selectedFilterId)'
        },
        /**
         * Placeholder for second input string
         */
        placeholder2: {
          type: String,
          computed: '_computePlaceholder2(selectedFilterId)'
        },
        /**
         * Show/Hide first input string
         */
        input0Visible: {
          type: Boolean,
          computed: '_computeVisible0(selectedFilterId)'
        },
        /**
         * Show/Hide second input string
         */
        input1Visible: {
          type: Boolean,
          computed: '_computeVisible1(selectedFilterId)'
        },
        /**
         * Show/Hide notch dropdown menu
         */
        input2Visible: {
          type: Boolean,
          computed: '_computeVisible2(selectedFilterId)'
        }
      },

      listeners: {
        'iron-overlay-opened': '_onOpen',
        'iron-overlay-closed': '_onClose'
      },
      _computeOnSingleChannel: function(onChannels) {
        return onChannels.length === 1;
      },
      _computeNrChannels: function(onChannels) {
        return onChannels.length;
      },
      _computeVisible0: function(option) {
        switch (option) {
          case 'lowpass':
            return false
          case 'highpass':
            return false
          case 'bandpass':
            return false
          default:
            return true
        }
      },
      _computeVisible1: function(option) {
        switch (option) {
          case 'lowpass':
            return true
          case 'highpass':
            return true
          case 'bandpass':
            return false
          default:
            return true
        }
      },
      _computeVisible2: function(option) {
        switch (option) {
          case 'bandstop':
            return false
          default:
            return true
        }
      },
      _computePlaceholder1: function(option) {
        switch (option) {
          case 'lowpass':
            return 'Low Pass Cutoff Frequency (Hz)'
          case 'highpass':
            return 'High Pass Cutoff Frequency (Hz)'
          case 'bandpass':
            return 'Low Pass Cutoff Frequency (Hz)'
          default:
            return ''
        }
      },
      _computePlaceholder2: function(option) {
        switch (option) {
          case 'bandpass':
            return 'High Pass Cutoff Frequency (Hz)'
          default:
            return ''
        }
      },
      _computeValidateFilter: function(input0, input1, selectedFilterId, selectedNotchId ) {
        return true;
      },

      /**
       * Compute heading
       * @param {Boolean} isCreating
       * @returns {String}
       */
       _computeHeading: function(isCreating) {
         return this.isCreating ? 'Set filter' : 'Edit filter';
      },

      /**
       * Compute button text
       * @param {Boolean} isCreating
       * @returns {String}
       */
      _computeButton: function(isCreating) {
        return this.isCreating ? 'Set filter' : 'Edit filter';
      },

      /**
       * Fire event to create add filter to selected channels
       */
      submitForm: function(e) {
        this.set('processing', true);
        this.fire('updateFilters', {
          selChannels: this.onChannels,
          filterType: this.selectedFilterId,
          input0: this.input0,
          input1: this.input1,
          notch: this.selectedNotchId});
      },

      /**
       * Callback when opening the dialog
       * Focus on first input
       */
      _onOpen: function() {
        if (this.selectedFilterId.length) {
          this.isCreating = false;
          this.$.filterSelect.set('selectedValue', this.selectedFilterId);
        } else {
          this.isCreating = true;
          this.$.filterSelect.set('selectedValue', this._filters[0].value);
        }

        this.$$('bf-input').focus();
      },

      /**
       * Callback when closing the dialog
       * Reset the properties
       * @param (Object) Event
       * @param {Object} detail
       */
      _onClose: function(e, detail) {
        this.set('annotation', {});
        this.set('label', '');
        this.set('description', '');
        this.set('processing', false);
      }
    });

  </script>

</dom-module>
