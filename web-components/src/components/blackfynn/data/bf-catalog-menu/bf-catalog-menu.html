<link rel="import" href="../../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../shared/bf-icon-circle/bf-icon-circle.html">
<link rel="import" href="../../shared/bf-share-item/bf-share-item.html">
<link rel="import" href="../../../../styles/blackfynn/main.html">
<link rel="import" href="../../../../styles/blackfynn/icons.html">

<!--
## bf-catalog-menu

`<bf-catalog-menu>` is the view for a user's catalog.
-->

<dom-module id="bf-catalog-menu">

  <template>
    <style include="blackfynn-main-styles"></style>
    <style type="text/css">
      :host {
        @apply(--layout-horizontal);
        @apply(--layout-flex);
        @apply(--layout-end-justified);
      }
      .icon-menu {
        color: var(--glial);
        cursor: pointer;
        height: 18px;
        width: 18px;
      }
      .sharedWith {
        color: var(--glial);
        font-size: 13px;
        line-height: 17px;
        margin-right: 15px;
        @apply(--layout-vertical);
        @apply(--layout-center-center);
      }
      #infoIcon {
        cursor: pointer;
        margin-left: 15px;
      }
      bf-icon-circle:hover .icon-menu {
        color: var(--app-primary-color)
      }
    </style>

    <template is="dom-if" if="[[isDataset]]">
      <div class="sharedWith">[[numberCollaborators]]</div>

      <bf-icon-circle id="sharingIcon" on-tap="showShareDialog">
        <iron-icon
          class="icon-menu"
          icon="blackfynn:icon-sharing"></iron-icon>
      </bf-icon-circle>
    </template>

    <bf-icon-circle id="infoIcon" on-tap="openInfoPanel">
      <iron-icon
        id="infoPanel"
        class="icon-menu"
        icon="blackfynn:icon-info-i"></iron-icon>
    </bf-icon-circle>

    <paper-tooltip
      for="infoPanel"
      position="top">Info</paper-tooltip>

    <bf-share-item
      id="shareItem"
      cur-package="[[curPackage]]"
      views="{{views}}"></bf-share-item>

  </template>

  <script>
    Polymer({
      is: 'bf-catalog-menu',

      properties: {
        /**
         * number of collaborators
         */
        numberCollaborators: {
          type: String,
          computed: '_getNumberCollaborators(curPackage.*)'
        },
        /**
         * determines if package is a dataset
         */
        isDataset: {
          type: Boolean,
          computed: '_computeIsDataset(curPackage.content.packageType)'
        },
      },

      /**
       * Show the share dialog
       * @param {Object} Event object
       * @param {Object} detail - xhr response
       */
       showShareDialog: function(e, detail) {
        this.$.shareItem.$.dialog.open();
      },

      /**
       * Check if dataset is shared
       * @param {Object} collaboratorCounts
       * @returns {Boolean}
       */
      _isShared: function(collaboratorCounts) {
        const collaborators = R.defaultTo({}, collaboratorCounts);
        const totalCount = Object.keys(collaborators).reduce((accum, key) => {
          return accum += collaboratorCounts[key];
        }, 0);
        return totalCount > 0;
      },

      /**
       * Computes the number of collaborators and returns a string
       * @param {Object} collaboratorCounts
       */
      _getNumberCollaborators: function(curPackage) {
        const collaborators = R.pathOr({}, ['base', 'collaboratorCounts'], curPackage);
        if(!this._isShared(collaborators)) {
          return 'Not Shared';
        }
        let sharedWithTeams = false;
        let sharedText = 'Shared with ';

        if (collaborators.organizations && collaborators.organizations !== 0) {
          sharedText += 'everyone';
        } else {
          // teams
          if (collaborators.teams && collaborators.teams > 0) {
            const teamCount = collaborators.teams;
            sharedWithTeams = true;
            sharedText += `${teamCount} team`;
            if (teamCount > 1) {
              sharedText += 's'; //pluralize
            }
          }
          // users
          if (collaborators.users && collaborators.users > 0) {
            const userCount = collaborators.users;
            if (sharedWithTeams) {
              sharedText += ' and ';
            }
            sharedText += `${userCount} user`;
            if (userCount > 1) {
              sharedText += 's'; //pluralize
            }
          }
        }

        return sharedText;
      },

      /**
       * fires event to open info panel
       */
      openInfoPanel: function() {
        this.fire('toggle-info-panel');
      },

      /**
       * Checks if package is a dataset
       * @param {String} packageType
       */
      _computeIsDataset: function(packageType) {
        return packageType && packageType.toLowerCase() === 'dataset';
      },

    });

  </script>

</dom-module>
