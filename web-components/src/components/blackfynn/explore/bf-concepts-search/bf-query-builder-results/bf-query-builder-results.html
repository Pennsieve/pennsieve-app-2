<link rel="import" href="../../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../shared/scroll-threshold/scroll-threshold.html">
<link rel="import" href="../../../state/bf-state-aware-behavior.html">
<link rel="import" href="../../bf-concepts-instance-behavior.html">
<link rel="import" href="./bf-query-builder-no-results.html">
<link rel="import" href="../../../../../vendor-scripts.html">

<link rel="import" href="../../../../../styles/blackfynn/main.html">
<link rel="import" href="../../../../../styles/blackfynn/grid.html">

<!--
## bf-query-builder-results

`<bf-query-builder-results>` is a component for displaying query builder results for a concept.

@element bf-query-builder-results
@demo demo/index.html
-->

<dom-module id="bf-query-builder-results">
  <template>
    <style include="blackfynn-main-styles"></style>
    <style include="bf-grid-styles"></style>
    <style>
      :host {
        display: block;
        margin-top: 20px;
      }
      .results-header {
        background-color: #F7F7F7;
        border-top: solid 1px var(--cortex);
        border-bottom: solid 1px var(--cortex);
        height: 35px;
        margin-bottom: 20px;

        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      h2 {
        font-weight: 500;
        font-size: 13px;
        margin: 0;

        @apply(--layout-flex);
      }
      .results-count {
        text-align: right;
        color: var(--glial);
        line-height: 24px;
      }
      .result-row {
        border-bottom: solid 1px rgba(218,218,218,0.5);
        height: 38px;
        margin: 0;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .result-row strong {
        text-transform: capitalize;
      }
      .column {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        @apply(--layout-flex);
      }
    </style>

    <div class="results-header">
      <div class="container">
        <div class="row">
          <div class="col-sm-6">
            <h2>Results</h2>
          </div>
          <!-- <div class="col-sm-6 results-count">
            [[concept.count]] Results
          </div> -->
        </div>
      </div>
    </div>

    <div class="container" hidden$="[[!hasResults]]">
      <div class="result-row">
        <div class="column"><strong>[[_computeHeading(headings)]]</strong></div>
        <template is="dom-repeat" items="[[headings]]" as="heading">
          <template is="dom-if" if="[[_lessThanMax(index)]]">
            <div class="column"><strong>[[heading]]</strong></div>
          </template>
        </template>
      </div>
      <div class="threshold-wrap">
        <scroll-threshold id="threshold">
          <iron-list id="resultsList" items="[[results]]" as="result">
            <template>
                <div class="result-row">
                  <div class="column">
                    <a href="[[_computeInstanceDetailsUrl(state.activeOrganization.organization.id, concept.id, result.id)]]">
                      [[_computeName(result)]]
                    </a>
                  </div>
                  <template id="columnRender" is="dom-repeat" items="[[result.values]]">
                    <template is="dom-if" if="[[_lessThanMax(index)]]">
                      <div class="column">[[_formatDisplayData(item)]]</div>
                    </template>
                  </template>
                </div>
            </template>
          </iron-list>
        </scroll-threshold>
      </div>
    </div>

    <div class="container" hidden$="[[hasResults]]">
      <div class="row">
        <div class="col-sm-12">
          <bf-query-builder-no-results
            initial-concept="[[initialConcept]]"></bf-query-builder-no-results>
        </div>
      </div>
    </div>

  </template>
  <script>
    Polymer({
      is: 'bf-query-builder-results',

      behaviors: [
        StateAwareBehavior,
        Polymer.IronResizableBehavior,
        Blackfynn.ConceptsInstanceBehavior
      ],

      properties: {
        /**
         * tracks whether or not query has results
         */
        hasResults: {
          type: Boolean,
          computed: '_computeHasResults(results.length, loadingResults)'
        },
        /**
         * tracks whether or not query is running
         */
        loadingResults: {
          type: Boolean,
          value: false
        },
        /**
         * list of results
         */
        results: {
          type: Array,
          value: function() {
            return [];
          }
        },
        /**
         * concept object
         */
        concept: {
          type: Object,
          value: function() {
            return {};
          }
        },
        /**
         * current page of search results
         */
        page: {
          type: Number,
          value: 0,
          notify: true
        },
        /**
         * current offset for search results
         */
        offset: {
          type: Number,
          value: 0,
          notify: true
        },
        /**
         * current limit for search results
         */
        limit: {
          type: Number
        }
      },

      listeners: {
        'iron-resize': '_onIronResize'
      },

      /**
       * Computes display of N number of columns
       */
      _lessThanMax: function(index) {
        return index < 4;
      },

      /**
       * Computes the instance details url
       * @param {String} activeOrgId
       * @param {String} conceptId
       * @param {String} instanceId
       * @returns {String}
       */
      _computeInstanceDetailsUrl: function(activeOrgId, conceptId, instanceId) {
        return `/${activeOrgId}/explore/detail/${conceptId}/${instanceId}`;
      },

      /**
       * Computes whether or not schema item is the name field
       * @param {Object} schemaObject
       * @returns {Boolean}
       */
       _isNameField: function(schemaObject) {
        return schemaObject.name === 'name';
      },

      /**
       * Computes whether or not there are results
       */
      _computeHasResults: function(resultsLength, loadingResults) {
        return resultsLength > 0 && !loadingResults;
      },

      /**
       * Loads more data when scrollthreshold is hit
       */
      loadMoreData: function() {
        if (this.results.length === 0) {
          return;
        }
        const nextPage = this.page + 1;
        this.set('page', nextPage);

        const updatedOffset = nextPage * this.limit + 1;
        this.set('offset', updatedOffset);

        this.fire('load-more-data', this.offset);
        this.$.resultsList.fire('resize');
      },

      /**
       * Format display data
       * @param {Object} item
       * @returns {String}
       */
      _formatDisplayData: function(item) {
        switch(item.dataType) {
          case 'Double':
            return parseFloat(item.value).toFixed(2);
          case 'Date':
            return moment(item.value).utc().format('M/D/YYYY h:mma');
          default:
            return item.value;
        }
      },

      /**
       * Set the results height to fill the rest of the page
       */
      setResultsHeight: function() {
        const results = this.$.threshold;
        const offsetTop = results.offsetTop;
        const windowHeight = window.innerHeight;

        const resultsHeight = windowHeight - offsetTop;

        results.style.height = `${resultsHeight}px`;
      },

      /**
       * Callback on iron resize
       */
      _onIronResize: function() {
        this.debounce('on-resize', function() {
          this.cancelDebouncer('on-resize');

          this.setResultsHeight();
          this.$.resultsList.fire('resize');
        }, 200);
      }

    });
  </script>
</dom-module>
