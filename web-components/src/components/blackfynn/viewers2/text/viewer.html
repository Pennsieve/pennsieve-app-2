<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../shared/bf-viewer-package-title.html">
<link rel="import" href="../../shared/show-pkg-title-behavior.html">
<link rel="import" href="../../shared/bf-ajax-behavior.html">
<link rel="import" href="../static-viewer-behavior.html">

<link rel="import" href="../../../../styles/blackfynn/highlight.html">
<script src="lib/highlight.pack.js"></script>

<dom-module id="bf-viewer-text">
  <template>
    <style include="blackfynn-highlight"></style>
    <style type="text/css">
      :host {
        overflow: hidden;
        width: 100%;
        background: white;
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-flex);
      }
      #codeblock {
        overflow: visible;
      }
      .wrapper {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        z-index: 1;
        overflow: auto;
      }
    </style>

    <template is="dom-if" if="[[showPkgTitle]]">
      <bf-viewer-package-title
        is-active="[[isActive]]"
        title="[[data.name]]"></bf-viewer-package-title>
    </template>

    <div class="wrapper">
      <pre>
        <code id="codeblock" class$="[[subtype]]">[[fileData]]</code>
      </pre>
    </div>

    <iron-ajax
      auto
      id="getViewerData"
      method="GET"
      url="[[getViewerDataUrl]]"
      loading="{{isLoadingViewerData}}"
      content-type="application/json"
      handle-as="json"
      on-response="_handleGetViewerData"
      on-error="ajaxError"></iron-ajax>
  </template>

  <script>
    Polymer({
      is: 'bf-viewer-text',

      properties: {
        fileData: {
          type: String,
          value: ''
        },
        subtype: {
          type: String,
          value: 'text'
        },
      },

      behaviors: [
        Blackfynn.StaticViewerBehavior,
        Blackfynn.ShowPkgTitleBehavior,
        Blackfynn.AjaxBehavior
      ],

      observers: [
        '_watchViewerDataId(viewerDataId)'
      ],

      _watchViewerDataId: function(viewerDataId) {
        if (viewerDataId) {
          this.getData()
        }
      },

      /**
      * Fetch file data
      */
      getData: function() {
        fetch(this.getFileUrl)
          .then(response => response.text())
          .then(data => {
            this.fileData = data

            const hljs = window.hljs;
            const codeblock = this.$.codeblock

            hljs.configure();
            hljs.highlightBlock(codeblock);
          })
          .catch(this.ajaxError.bind(this))
      }
    });
  </script>
</dom-module>
