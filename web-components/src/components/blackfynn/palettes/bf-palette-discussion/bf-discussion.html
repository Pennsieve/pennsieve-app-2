<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../shared/bf-ajax-behavior.html">
<link rel="import" href="../../shared/bf-icon-circle/bf-icon-circle.html">
<link rel="import" href="bf-discussion-comment.html">
<link rel="import" href="bf-discussion-add-comment.html">
<link rel="import" href="../../shared/bf-mentions/bf-mention-tag-behavior.html">
<link rel="import" href="../../shared/vuex-behavior/vuex-behavior.html">

<link rel="import" href="../../../../styles/blackfynn/main.html">

<!--
## bf-discussion

`<bf-discussion>` is a component that wraps a discussion.

@demo
-->

<dom-module id="bf-discussion">

  <template>
    <style include="blackfynn-main-styles"></style>
    <style type="text/css">
      :host {
        border-bottom: 1px solid var(--cortex);
        padding-top: 30px;
        position: relative;
        @apply(--layout-vertical);
      }
      :host(:hover) {
        background: var(--white-matter);
      }
      #annotation {
        font-size: 12px;
        margin-bottom: 20px;
        padding: 0 15px 0 13px;
        position: relative;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      #btnArchive {
        font-size: 13px;
        line-height: 1;
        position: absolute;
        top: 10px;
        right: 10px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      #btnArchive[hidden] {
        display: none
      }

      #btnArchive iron-icon {
        height: 16px;
        width: 16px;
      }
    </style>

    <div id="annotation" hidden$="[[!_hasAnnotation]]">
      <ul class="dot-list">
        <li><a href="#" class="plain" on-tap="jumpToAnnotation">Jump to annotation</a></li>
        <li><a href="#" class="plain" on-tap="viewAnnotation">View details</a></li>
      </ul>
    </div>

    <template id="commentRepeater" is="dom-repeat" items="[[comments]]" sort="[[sortMethod]]">
      <bf-discussion-comment
        comment="[[item]]"
        is-hovered="[[isHovered]]"
        discussion-id="[[discussion.id]]"
        user-map="[[userMap]]"
      >
      </bf-discussion-comment>
    </template>

    <bf-discussion-add-comment
      id="addcomment"
      hidden$="[[!isReplying]]"
      discussion-id="[[discussion.id]]"
    >
    </bf-discussion-add-comment>

    <template is="dom-if" if="[[_isOwner]]">
      <a href="#" id="btnArchive" class="plain" hidden$="[[!isHovered]]" on-tap="archiveDiscussion"><span>Archive</span> <iron-icon icon="blackfynn:delete"></iron-icon></iron-icon>
    </template>

    <iron-ajax
      id="deleteDiscussionAjax"
      method="DELETE"
      content-type="application/json"
      handle-as="json"
      params="[[getDiscussionsParams]]"
      on-error="ajaxError"></iron-ajax>

    <iron-ajax
      id="addCommentAjax"
      method="POST"
      content-type="application/json"
      handle-as="json"
      params="[[getDiscussionsParams]]"
      loading="{{loadingDiscussions}}"
      url="[[addCommentUrl]]"
      on-error="ajaxError"></iron-ajax>

  </template>

  <script>
    Polymer({
      is: 'bf-discussion',

      behaviors: [
        Blackfynn.AjaxBehavior,
        Blackfynn.MentionTagBehavior,
        Blackfynn.VuexBehavior
      ],

      properties: {
        /**
         * Sort attribute for data sets
         */
         sortMethod: {
          type: String,
          value: 'byUpdatedDate'
        },
        /**
         * User Map
         */
         userMap: {
          type: Object,
          value: function() {
            return {};
          }
        },
        /**
         * Comments
         */
         comments: {
          type: Array,
          value: function() {
            return [];
          }
        },
        /**
         * Discussion
         */
        discussion: {
          type: Object,
          value: function() {
            return {};
          }
        },
        /**
         * If the user is hovered over discussion
         */
        isHovered: {
          type: Boolean,
          value: false
        },
        /**
         * Compute if the discussion is about an annotation
         */
        _hasAnnotation: {
          type: Boolean,
          computed: '_computeHasAnnotation(discussion.annotation_id)'
        },
        /**
         * If the user is replying
         */
        isReplying: {
          type: Boolean,
          value: false
        },
        /**
         * If the user is the owner of the discussion
         */
        _isOwner: {
          type: Boolean,
          computed: '_computeIsOwner(vuex.profile.id, discussion.creator.id)'
        },
        /**
         * Computed property that returns get discussions parameters
         */
         getDiscussionsParams: {
          type: Object,
          computed: '_computeGetDiscussionsParams(vuex.userToken)'
        },
        /**
         * Computed property that returns create discussions api url
         */
         addCommentUrl: {
          type: String,
          computed: '_computeAddCommentUrl(vuex.config.apiUrl)'
        }
      },

      listeners: {
        'mouseenter': 'onMouseOver',
        'mouseleave': 'onMouseLeave',
        'remove-comment': 'removeComment',
        'add-comment': 'addComment',
        'set-replying': 'setReplying'
      },

      /**
       * Returns create discussions api endpoint
       * @param {String} apiUrl
       * @return {String} discussions endpoint
       */
       _computeAddCommentUrl: function(apiUrl) {
        return `${apiUrl}/discussions`;
      },

      /**
       * Sorting results by `ITEM.content.name`
       * @param {Object} data item #1 to compare
       * @param {Object} data item #2 to compare
       * @return {Number}
       */
       byUpdatedDate: function(item1, item2) {
        return item1.updatedAt.localeCompare(item2.updatedAt);
      },

      /**
       * Returns parameters for get discussions
       * @param {String} userToken
       * @return {Object} ajax parameters
       */
       _computeGetDiscussionsParams: function(userToken) {
        return {
          api_key: userToken
        }
      },

      /**
       * Compute if the discussion is about an annotation
       * @param {Object} annotation
       * @return {Boolean}
       */
      _computeHasAnnotation: function(annotationId) {
        return Boolean(annotationId);
      },

      /**
       * Compute if user is the owner of the discussion
       * @param {String} profileId
       * @param {String} creatorId
       * @return {Boolean}
       */
      _computeIsOwner: function(profileId, creatorId) {
        return profileId === creatorId;
      },

      /**
       * Mouse over
       */
      onMouseOver: function() {
        this.set('isHovered', true);
      },

      /**
       * Mouse leave
       */
      onMouseLeave: function() {
        this.set('isHovered', false);
      },

      /**
       * Remove comment from discussion
       * @param {Object} Event object
       * @param {Object} detail
       */
      removeComment: function(e, detail) {
        const comment = R.propOr({}, 'comment', detail);
        const discussionId = R.propOr(0, 'discussion_id', comment);
        const commentId = R.propOr(0, 'id', comment);

        const commentsIndex = this.getById(commentId, this.comments);
        if (commentsIndex < 0) {
          return this.fire('toast', { msg: 'Comment could not be deleted' } );
        }

        // build url
        const xhr = this.$.deleteDiscussionAjax;
        xhr.url = `${this.vuex.config.apiUrl}/discussions/${discussionId}/comment/${commentId}`;
        xhr
          .generateRequest()
          .completes
          .then(() => {
            this.$store.dispatch('viewer/removeComment', comment)
          });
      },

      /**
       * Get discussion by ID
       * @param {String}
       * @param {Array}
       * @return {Number}
       */
       getById: R.useWith(R.findIndex, [R.propEq('id')]),

      /**
       * Remove comment from discussion
       * @param {Object} Event object
       * @param {Object} detail
       */
      addComment: function(e, detail) {
        // Add comment
        const xhr = this.$.addCommentAjax;
        const message = R.prop('message', detail);
        const mentions = R.prop('mentions', detail);
        const packageId = R.path(['content', 'id'])(this.vuex.viewer.activeViewer);
        const discussionId = R.propOr(0, 'discussionId', detail);

        const transformedMessage = message.replace(/\<span(.*?)\<\/span>/g, this.createMentionTag);

        xhr.body = {
          message: transformedMessage,
          packageId,
          mentions,
          discussionId
        };
        const annotationId = R.pathOr(0, ['annotation', 'id'], detail);
        if (annotationId > 0) {
          xhr.body = R.assoc('annotationId', annotationId, xhr.body);
        }
        xhr
          .generateRequest()
          .completes
          .then((payload) => {
            const comment = R.pathOr([], ['response', 'comment'], payload)
            this.$store.dispatch('viewer/createComment', comment)

            this.$.commentRepeater.render();
          });
      },

      /**
       * User is replying to discussion
       * @param {Object} Event object
       * @param {Object} detail
       */
      setReplying: function(e, detail) {
        // Set is replying flag
        this.set('isReplying', detail.replying);

        // Focus on comment textarea
        if(detail.replying) {
          this.$.addcomment.$.commentTextarea.focus();
        }
      },

      /**
       * Archive the discussion
       */
      archiveDiscussion: function() {
        this.onArchive();
      },

      /**
       * Callback from API to archive the discussion
       * Handled by `bf-palette-discussion`
       * @param {Object} Event object
       * @param {Object} detail
       */
      onArchive: function(e, detail) {
        this.fire('delete-discussion', { id: this.discussion.id })
      },

      /**
       * Focus on the annotation in the slide viewer
       */
      jumpToAnnotation: function() {
        const id = this.get('discussion.annotation_id')
        this.fire('active-viewer-action', {
          method: 'focusAnnotation',
          payload: id
        })
      },

      /**
       * View the annotation in the annotation palette
       */
      viewAnnotation: function() {
        this.fire('view-annotation', {
          id: this.get('discussion.annotation_id')
        });
      }
    });

  </script>

</dom-module>
