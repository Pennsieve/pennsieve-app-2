<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/app-route/app-route.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../../../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="../../../../styles/blackfynn/icons.html">
<link rel="import" href="../../../../styles/blackfynn/main.html">
<link rel="import" href="../../../../styles/blackfynn/browse.html">
<link rel="import" href="../../../../vendor-scripts.html">
<link rel="import" href="./bf-data-set-item.html">
<link rel="import" href="../bf-empty-dataset/bf-empty-dataset.html">
<link rel="import" href="../../state/bf-state-aware-behavior.html">
<link rel="import" href="../../shared/bf-ajax-behavior.html">

<!--
## bf-data-set-list

`<bf-data-set-list>` is a list of all packages as data sets.

@element bf-data-set-list
@demo ./demo/dataset-list-demo.html
-->

<dom-module id="bf-data-set-list">

  <template>
    <style include="blackfynn-main-styles"></style>
    <style include="blackfynn-browse-styles"></style>
    <style type="text/css">
      :host {
        margin: 0 0 30px 30px;
        @apply(--layout-horizontal);
      }
      .load-wrap {
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
        @apply(--layout-flex);
      }
      .data-set-list {
        @apply(--layout-flex);
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
      }
    </style>

    <div id="browseContent" hidden$="[[isLoading]]">

      <bf-empty-dataset
        is-searching="[[state.isSearching]]"
        is-empty="[[isEmpty]]"
        packages="[[packages]]"
        catalog-route="[[catalogRoute]]"></bf-empty-dataset>

      <div class="data-set-list">
        <template is="dom-repeat" items="[[packages]]" sort="[[sortMethod]]">
          <bf-data-set-item
            data="{{item}}"
            selected="[[selected]]"
            node-types="[[nodeTypes]]"
            storage-metrics="[[dataStorageMetrics]]"></bf-data-set-item>
        </template>
      </div>

    </div>

    <div class="load-wrap" hidden$="[[!isLoading]]">
      <paper-spinner-lite id="browseLoading" active></paper-spinner-lite>
    </div>

    <iron-ajax
      id="getDataSetList"
      method="GET"
      handle-as="json"
      loading="{{isLoadingDatasets}}"
      url="[[dataSetListUrl]]"
      on-response="_handleGetDataSetList"
      on-error="ajaxError"></iron-ajax>

    <app-route
      route="{{catalogRoute}}"
      pattern="/:id"
      data="{{catalogRouteData}}"></app-route>
  </template>

  <script>
    Polymer({
      is: 'bf-data-set-list',

      properties: {
        /**
         * Current Package data
         */
        packages: {
          type: Array,
          value: []
        },
        /**
         * array of data storage metrics for all datasets
         */
        dataStorageMetrics: {
          type: Object,
          value: {}
        },
        /**
         * Computed property that returns data storage api url
         */
        dataStorageUrl: {
          type: String,
          computed: '_computeDataStorageUrl(state.apiUrl, state.userToken, packages)'
        },
        /**
         * Computed property that returns data set list api url
         */
        dataSetListUrl: {
          type: String,
          computed: '_computeDataSetListUrl(state.apiUrl, state.userToken, catalogRoute.path)'
        },
        /**
         * Sort attribute for data sets
         */
        sortMethod: {
          type: String,
          value: 'byName'
        },
        /**
         * Array of all items selected by the user
         */
        selected: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true
        },
        /**
         * Last selected item in the list. Used for shift+click selection
         */
        lastSelectedItem: {
          type: Object,
          value: function() {
            return {};
          }
        },
        /**
         * Current collection the user is in
         */
        curPackage: {
          type: Object,
          notify: true
        },
        /**
         * Catalog route
         */
        catalogRoute: {
          type: Object,
          value: function() {
            return {};
          }
        },
        /**
         * If search is loading
         */
        isLoadingDatasets: {
          type: Boolean,
          value: false
        },
        /**
         * Compute if search of datasets are loading
         */
        isLoading: {
          type: Boolean,
          computed: '_computeIsLoading(state.isLoadingSearch, isLoadingDatasets)'
        }
      },

      behaviors: [
        Blackfynn.AjaxBehavior,
        StateAwareBehavior,
      ],

      listeners: {
        'open-dataset': 'openDataset',
        'select-item': 'selectItem',
      },

      observers: [
        '_watchActiveOrg(state.activeOrganization.organization.id)'
      ],

      /**
       * Observe active organization and get new datasets if it changes
       * @param {String} activeOrganizationId
       */
      _watchActiveOrg: function(activeOrganizationId) {
        const getDatasetListAjax = this.$.getDataSetList;
        if (activeOrganizationId && getDatasetListAjax.get('auto')) {
          getDatasetListAjax.generateRequest();
        }
      },

      /**
       * Compute if search of datasets are loading
       * @param {Boolean} isLoadingSearch
       * @param {Boolean} isLoadingDatasets
       * @returns {Boolean}
       */
      _computeIsLoading: function(isLoadingSearch, isLoadingDatasets) {
        return isLoadingSearch || isLoadingDatasets;
      },

      /**
       * Displays data set content
       * @param {Object} Event object
       * @param {Object} Collection detail object
       */
      openDataset: function(e, detail) {
        const dataId = R.pathOr('', ['data', 'id'], detail);

        // Reset selected list
        this.set('selected', []);

        const catalogRoute = Boolean(dataId) ? `/${dataId}` : '';
        this.set('catalogRoute.path', catalogRoute);
      },

      /**
       * Returns node type of package; `false` if no nodeType could be determined
       * @param {Object} User's active organization data
       * @return {Object} Header object returning X-Organization-Id
       */
      _getNodeType: function(id, nodeTypes) {
        for (let i = 0; i < nodeTypes.length; i++) {
          if(id.indexOf(nodeTypes[i]) > 0) {
            return nodeTypes[i];
          }
        }
        return false;
      },

      /**
       * Returns datasets api endpoint
       * @param {String} api
       * @param {String} userToken
       * @param {String} catalogRoutePath
       * @return {String} datasets endpoint
       */
      _computeDataSetListUrl: function(api, userToken, catalogRoutePath) {
        const path = R.defaultTo('', catalogRoutePath);

        const auto = path.length === 0 && !this.state.isSearching && userToken ? true : false;
        this.$.getDataSetList.set('auto', auto);

        return `${api}/datasets?api_key=${userToken}&includeCollaboratorCounts: true`;
      },

      /**
       * Returns datasets storage api endpoint
       * @param {String} base api
       * @param {String} user
       * @param {Array} packages
       * @return {String} datasets storage endpoint
       */
      _computeDataStorageUrl: function(api, user, packages) {
        const dsValues = packages.reduce((accum, dataset) => {
          accum += `&ds=${dataset.content.id}`;
          return accum;
        }, '');
        const qString = `api_key=${user}&metric=DISK${dsValues}`;

        return `${api}/ledger/totalsByReference?${qString}`;
      },

      /**
       * Sorting results by `ITEM.content.name`
       * @param {Object} data item #1 to compare
       * @param {Object} data item #2 to compare
       * @return {Number}
       */
      byName: function(item1, item2) {
        return item1.content.name.localeCompare(item2.content.name);
      },

      /**
       * Call back handler for successful response from datasets endpoint
       * @param {Object} Event object
       * @param {Object} XHR response
       */
      _handleGetDataSetList: function(e, detail) {
        let packages = [];

        const responseData = detail.response.children ? detail.response.children : detail.response;

        for (let i = 0; i < responseData.length; i++) {
          packages.push(responseData[i]);
        }

        this.set('selected', []);
        this.set('packages', packages);
        this.set('processing', false);
        this.fire('update-packages', packages);
      },

      /**
       * Tracks data set item user has selected
       * @param {Object} Event object
       * @param {Object} active data set
       */
      selectItem: function(e, detail) {
        const indexOfItem = this.selected.indexOf(detail.item);

        // Check if the item is already selected
        if(indexOfItem === -1) {
          if(detail.metaKey) {
            // Add item to selected list
            this.push('selected', detail.item);
          } else {
            // Reset selected list and only have this item selected
            this.set('selected', [detail.item]);
          }

          this.set('lastSelectedItem', detail.item);
          this.fire('items-selected', this.selected);
        }
      },

      /**
       * Updates list of datasets
       * @param {Object} Event object
       * @param {Object} dataset
       */
      addDataset: function(e, detail) {
        const item = R.propOr({}, 'item', detail);
        this.push('packages', item);

        const data = R.prop('content', item);
        this.fire('open-dataset', { data });
      },

      /**
       * Updates dataset list with edited dataset
       * @param {Object} Event object
       * @param {Object} dataset response
       */
      reloadDataset: function(e, detail) {
        // dataset id to edit
        const datasetId = R.path(['content', 'id'], detail);
        // get index to use for dataset
        const datasetIndex = R.findIndex(
          R.pathEq(['content', 'id'], datasetId),
          this.packages
        );
        this.set(`packages.${datasetIndex}`, detail);
      },

      /**
       * When the collaborators on a dataset were changed in the Info Panel
       * @param {Object} { id, collaboratorCounts }
       */
      updateCollaborators: function(detail) {
        const datasetIndex = R.findIndex(
          R.pathEq(['content', 'id'], detail.itemId),
          this.packages
        );

        this.set(`packages.${datasetIndex}.collaboratorCounts`, detail.counts);
      }

    });
  </script>
</dom-module>
