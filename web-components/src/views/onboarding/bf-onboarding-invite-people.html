<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="../../components/blackfynn/shared/bf-input/bf-input.html">

<link rel="import" href="../../config/config.html">
<link rel="import" href="../../components/blackfynn/shared/bf-ajax-behavior.html">
<link rel="import" href="../../components/blackfynn/state/bf-state-aware-behavior.html">

<link rel="import" href="../../styles/blackfynn/main.html">
<link rel="import" href="../../styles/blackfynn/login.html">

<dom-module id="bf-onboarding-invite-people">

  <template>
    <style include="blackfynn-main-styles"></style>
    <style include="blackfynn-login-styles"></style>
    <style>
      :host {
        background: var(--white-matter);
        display: block;
        color: var(--glial);
        min-height: 100vh;
      }
      .container {
        margin: 0 auto;
        max-width: 560px;
        padding-bottom: 20px;
        padding-top: 130px;
        text-align: center;
      }
      paper-button {
        margin: 0 10px;
        min-width: 160px;
      }
      .button-wrap {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        @apply(--layout-center);
      }
    </style>

    <div class="container">

      <h2 class="sharp-sans">Invite people from your team.</h2>
      <p>Science is more fun with a team. Enter email addresses for people you would like to invite to Blackfynn. Weâ€™ll generate them an email to join.</p>

      <div id="inviteWrap">
        <template is="dom-repeat" items="[[people]]">
          <bf-input
            autofocus
            value="{{item.email}}"
            type="email"
            placeholder="Enter an email address."></bf-input>
        </template>
      </div>

      <p>
        <a href="#" hidden$="[[processing]]" on-tap="addPerson">Add another person&hellip;</a>
      </p>

      <div class="button-wrap">

        <paper-button
          class="light"
          noink
          hidden$="[[processing]]"
          on-tap="sendInvites">Send invites</paper-button>

        <paper-button
          noink
          hidden$="[[processing]]"
          on-tap="goToDatasets">Skip for now</paper-button>

        <paper-spinner-lite
          active$="[[processing]]"
          hidden$="[[!processing]]"></paper-spinner-lite>

      </div>

    </div>

    <iron-ajax
      id="sendInvites"
      method="POST"
      content-type="application/json"
      handle-as="json"
      loading="{{processing}}"
      url="[[sendInvitesUrl]]"
      on-response="goToDatasets"
      on-error="ajaxError"></iron-ajax>

    <iron-a11y-keys
      target="[[keyTarget]]"
      keys="enter"
      on-keys-pressed="sendInvites"></iron-a11y-keys>

  </template>

  <script>

    Polymer({
      is: 'bf-onboarding-invite-people',

      behaviors: [
        Blackfynn.Config,
        Blackfynn.AjaxBehavior,
        StateAwareBehavior
      ],

      properties: {
        people: {
          type: Array,
          value: [
            { email: '' },
            { email: '' },
            { email: '' }
          ]
        },
        /*
         * Compute send invites URL
         */
        sendInvitesUrl: {
          type: String,
          computed: '_computeSendInvitesUrl(apiUrl, userToken, activeOrganizationId)'
        },
        /*
         * Send invites iron-ajax is loading
         */
        processing: {
          type: Boolean,
          value: false
        },
        /*
         * Target for a11y keys, submitting the form
         */
        keyTarget: {
          type: Element,
          value: function() {
            return this.$.inviteWrap;
          }
        }
      },

      /*
       * Compute send invites URL
       */
      _computeSendInvitesUrl: function(apiUrl, userToken, id) {
        return `${apiUrl}/organizations/${id}/members?api_key=${userToken}`;
      },

      /*
       * Add another person
       */
      addPerson: function() {
        if(!this.maxPeople) {
          // Add person
          this.push('people', { email: '' });

          // Focus on new field
          this.async(function() {
            const inputs = Polymer.dom(this.root).querySelectorAll('bf-input');
            inputs[inputs.length - 1].focus();
          }, 100);
        }
      },

      /*
       * Send invites
       */
      sendInvites: function() {
        let isNotEmpty = obj => obj.email !== '';
        const people = [...this.people]

        people.forEach(person => {
          person.firstName = ''
          person.lastName = ''
        })

        const invites = R.filter(isNotEmpty, people);

        this.$.sendInvites.body = {
          invites
        }
        this.$.sendInvites.generateRequest();
      },

      /*
       * Go to the datasets
       */
      goToDatasets: function() {
        this.fire('set-vue-route', { name: 'datasets-list' })
      }
    });

  </script>

</dom-module>
