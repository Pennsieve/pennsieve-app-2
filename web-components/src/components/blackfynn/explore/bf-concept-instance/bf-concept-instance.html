<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/app-route/app-route.html">
<link rel="import" href="../../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="../../data/bf-card/bf-card.html">
<link rel="import" href="./bf-concept-instance-detail.html">
<link rel="import" href="../bf-latest-packages/bf-latest-packages.html">
<link rel="import" href="../../data/bf-data-item/bf-data-item.html">
<link rel="import" href="../../shared/bf-empty-state/bf-empty-state.html">

<link rel="import" href="../../shared/item-icon-behavior.html">
<link rel="import" href="../../shared/bf-ajax-behavior.html">
<link rel="import" href="../../state/bf-state-aware-behavior.html">
<link rel="import" href=".././bf-concepts-ajax-behavior.html">
<link rel="import" href="../bf-concepts-instance-behavior.html">

<link rel="import" href="../bf-relationships-list/bf-relationships-list.html">

<link rel="import" href="../../../../styles/blackfynn/icons.html">
<link rel="import" href="../../../../styles/blackfynn/explore.html">
<link rel="import" href="../../../../styles/blackfynn/grid.html">

<dom-module id="bf-concept-instance">

  <template>

    <style include="blackfynn-main-styles"></style>
    <style include="bf-grid-styles"></style>
    <style include="bf-explore-styles"></style>
    <style>
      :host {
        background-color: var(--white-matter);
        box-sizing: border-box;
        display: block;
        padding-top: 20px;
        @apply(--layout-vertical);
        @apply(--layout-flex);
        @apply(--layout-scroll);
      }
      .flex {
        @apply(--layout-wrap);
        @apply(--layout-horizontal);
      }
      bf-concept-instance-detail {
        flex-basis: 50%;
        margin-bottom: 20px;
      }
      bf-card {
        margin-bottom: 20px;
      }
      #title {
        margin-bottom: 20px;
        padding-left: 20px;
      }
      #title .id {
        display: block;
        font-size: 24px;
        font-weight: 700;
        line-height: 29px
      }
      #title .type {
        color: var(--glial);
        display: block;
      }
      #loadingWrap {
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
        @apply(--layout-center);
        @apply(--layout-flex);
      }
      .loading-spinner {
        height: 24px;
        width: 24px;
      }
    </style>

    <div class="container" hidden$="[[isLoading]]">

      <div class="row">
        <div class="col-xs-8">
          <div id="title">
            <span class="type">[[node.type]]</span>
            <span class="id">[[_name]]</span>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-xs-8">
          <bf-card heading="[[node.type]] Details">
            <div slot="body" class="padding flex">

              <bf-empty-state hidden$="[[!_hasDetails]]">
                <p class="no-margin">No details for [[_name]]. Add details with the <a href="http://docs.blackfynn.io/" target="_blank">Blackfynn API</a>.</p>
              </bf-empty-state>

              <template is="dom-repeat" items="[[node.values]]">
                <bf-concept-instance-detail item="[[item]]"></bf-concept-instance-detail>
              </template>

            </div>
          </bf-card>

          <bf-card heading="Latest Files &amp; Packages">
            <bf-latest-packages slot="body" node="[[node]]" packages="[[packages]]" concept-name="[[_name]]"></bf-latest-packages>
          </bf-card>

        </div>

        <div class="col-xs-4">

          <bf-card heading="Relationships">
            <bf-relationships-list slot="body" concepts="[[concepts]]"></bf-relationships-list>
          </bf-card>

        </div>
      </div>
    </div>

    <div id="loadingWrap" hidden$="[[!isLoading]]">
      <paper-spinner-lite class="loading-spinner" active="[[isLoading]]"></paper-spinner-lite>
    </div>

    <app-route
      route="{{route}}"
      pattern="/:conceptId/:instanceId"
      data="{{routeData}}"></app-route>

    <iron-ajax
      auto$="[[ironSelected]]"
      id="getConcept"
      handle-as="json"
      content-type="application/json"
      url="[[_getConceptUrl]]"
      loading="{{isLoading}}"
      on-response="_onGetConcept"
      headers="[[_conceptHeaders]]"></iron-ajax>

    <iron-ajax
      id="getPackage"
      handle-as="json"
      content-type="application/json"></iron-ajax>
  </template>

  <script>

    Polymer({
      is: 'bf-concept-instance',

      behaviors: [
        Blackfynn.AjaxBehavior,
        Blackfynn.ConceptsAjaxBehavior,
        StateAwareBehavior,
        Blackfynn.ItemIconBehavior,
        Blackfynn.ConceptsInstanceBehavior
      ],

      properties: {
        /**
         * Node
         */
        node: {
          type: Object,
          value: function() {
            return {};
          }
        },
        /**
         * Edges
         */
        edges: {
          type: Array,
          value: function() {
            return [];
          }
        },
        /**
         * Concepts
         */
        concepts: {
          type: Array,
          value: function() {
            return [];
          }
        },
        /**
         * Proxy concepts
         */
        proxyConcepts: {
          type: Array,
          value: function() {
            return [];
          }
        },
        /**
         * Compute if the instance has details
         */
        _hasDetails: {
          type: Boolean,
          computed: '_computeHasDetails(node.values.*)'
        },
        /**
         * Compute name
         */
        _name: {
          type: Boolean,
          computed: '_computeName(node)'
        },
        /**
         * Get concept URL based off of route
         */
         _getConceptUrl: {
           type: String,
           computed: '_computeGetConceptUrl(state.conceptsUrl, routeData.conceptId, routeData.instanceId)'
         },
         packages: {
           type: Array,
           computed: '_computePackages(proxyConcepts)'
         },
         /**
          * Loading concept instance
          */
         isLoading: {
           type: Boolean,
           value: false
         },
         /**
          * If the view is current shown to the user
          */
        ironSelected: {
          type: Boolean,
          value: false
        }
      },

      /**
        * Compute if the instance has details
        * @param {Object} values
        * @returns {Boolean}
        */
      _computeHasDetails: function(values) {
        const base = R.defaultTo([], R.prop('base', values))
        return Boolean(base.length <= 0);
      },

      /**
       * Compute GET concept URL based off of route
       * @param {String} conceptsUrl
       * @param {String} conceptId
       * @param {String} instanceId
       * @returns {String}
       */
      _computeGetConceptUrl: function(conceptsUrl, conceptId, instanceId) {
        return `${conceptsUrl}/concepts/${conceptId}/instances/${instanceId}`;
      },

      _computePackages: function(proxyConcepts) {
        const fields = proxyConcepts.map(R.pick(['values', 'createdAt']));

        const _createPairs = fields.map(f => {
          return f.values.map(v => {
            const obj = {};
            obj[v.name] = v.value;
            return obj;
          })
        });

        const mergedValues = _createPairs.map(R.mergeAll);

        const output = fields.map((f, idx) => {
          const created = {createdAt: f.createdAt};
          return Object.assign({}, created, mergedValues[idx]);
        });

        return output;
      },

    });

  </script>

</dom-module>
